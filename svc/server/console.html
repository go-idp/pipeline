<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pipeline Console</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: #f5f5f5;
            color: #333;
            line-height: 1.6;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px 0;
            margin-bottom: 30px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        header h1 {
            text-align: center;
            font-size: 28px;
            font-weight: 600;
        }

        .toolbar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            background: white;
            padding: 15px 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .toolbar button {
            background: #667eea;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            transition: background 0.3s;
        }

        .toolbar button:hover {
            background: #5568d3;
        }

        .toolbar button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }

        .status-filter {
            display: flex;
            gap: 10px;
        }

        .status-filter button {
            background: #f0f0f0;
            color: #333;
            padding: 8px 16px;
        }

        .status-filter button.active {
            background: #667eea;
            color: white;
        }

        .pipelines-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .pipeline-card {
            background: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            transition: transform 0.2s, box-shadow 0.2s;
            cursor: pointer;
        }

        .pipeline-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }

        .pipeline-card.running {
            border-left: 4px solid #667eea;
        }

        .pipeline-card.succeeded {
            border-left: 4px solid #10b981;
        }

        .pipeline-card.failed {
            border-left: 4px solid #ef4444;
        }

        .pipeline-card.pending {
            border-left: 4px solid #f59e0b;
        }

        .pipeline-header {
            margin-bottom: 15px;
        }

        .pipeline-name {
            font-size: 18px;
            font-weight: 600;
            color: #1f2937;
            margin-bottom: 5px;
        }

        .pipeline-id {
            font-size: 12px;
            color: #6b7280;
            font-family: monospace;
        }

        .pipeline-status {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
        }

        .pipeline-status.running {
            background: #dbeafe;
            color: #1e40af;
        }

        .pipeline-status.succeeded {
            background: #d1fae5;
            color: #065f46;
        }

        .pipeline-status.failed {
            background: #fee2e2;
            color: #991b1b;
        }

        .pipeline-status.pending {
            background: #fef3c7;
            color: #92400e;
        }

        .pipeline-status.cancelled {
            background: #f3f4f6;
            color: #4b5563;
        }

        .cancel-btn {
            background: #ef4444;
            color: white;
            border: none;
            padding: 6px 14px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 13px;
            font-weight: 500;
            white-space: nowrap;
            flex-shrink: 0;
            transition: background-color 0.2s;
        }

        .cancel-btn:hover {
            background: #dc2626;
        }

        .cancel-btn:active {
            background: #b91c1c;
        }

        .pipeline-info {
            display: flex;
            flex-direction: column;
            gap: 8px;
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid #e5e7eb;
        }

        .pipeline-info-item {
            display: flex;
            justify-content: space-between;
            font-size: 14px;
        }

        .pipeline-info-label {
            color: #6b7280;
        }

        .pipeline-info-value {
            color: #1f2937;
            font-weight: 500;
        }


        .logs-container {
            background: #1f2937;
            color: #e5e7eb;
            padding: 15px;
            border-radius: 6px;
            font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
            font-size: 13px;
            line-height: 1.6;
            max-height: 500px;
            overflow-y: auto;
        }

        .log-entry {
            margin-bottom: 4px;
            word-wrap: break-word;
        }

        .log-entry.stdout {
            color: #e5e7eb;
        }

        .log-entry.stderr {
            color: #fca5a5;
        }

        .log-entry.status {
            color: #93c5fd;
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #6b7280;
        }

        .empty-state svg {
            width: 120px;
            height: 120px;
            margin-bottom: 20px;
            opacity: 0.5;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #6b7280;
        }

        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .pipeline-details {
            margin-bottom: 20px;
        }

        .detail-row {
            display: flex;
            padding: 12px 0;
            border-bottom: 1px solid #e5e7eb;
        }

        .detail-label {
            width: 150px;
            color: #6b7280;
            font-weight: 500;
        }

        .detail-value {
            flex: 1;
            color: #1f2937;
        }

        .tabs {
            display: flex;
            border-bottom: 2px solid #e5e7eb;
            margin: 20px 0;
        }

        .tab {
            padding: 12px 20px;
            cursor: pointer;
            color: #6b7280;
            font-weight: 500;
            border-bottom: 2px solid transparent;
            margin-bottom: -2px;
            transition: color 0.3s;
        }

        .tab:hover {
            color: #1f2937;
        }

        .tab.active {
            color: #667eea;
            border-bottom-color: #667eea;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .yaml-viewer {
            background: #1f2937;
            color: #e5e7eb;
            padding: 15px;
            border-radius: 6px;
            font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
            font-size: 13px;
            line-height: 1.6;
            max-height: 500px;
            overflow-y: auto;
            white-space: pre-wrap;
            word-wrap: break-word;
        }

        .yaml-container {
            position: relative;
        }

        .copy-yaml-btn {
            position: absolute;
            top: 10px;
            right: 10px;
            background: #3b82f6;
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            font-weight: 500;
            transition: background-color 0.2s;
            z-index: 10;
        }

        .copy-yaml-btn:hover {
            background: #2563eb;
        }

        .copy-yaml-btn:active {
            background: #1d4ed8;
        }

        .copy-yaml-btn.copied {
            background: #10b981;
        }

        .settings-form {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .form-label {
            font-weight: 500;
            color: #1f2937;
        }

        .form-input {
            padding: 10px;
            border: 1px solid #e5e7eb;
            border-radius: 6px;
            font-size: 14px;
        }

        .form-input:focus {
            outline: none;
            border-color: #667eea;
        }

        .form-help {
            font-size: 12px;
            color: #6b7280;
        }

        .error-message {
            background: #fee2e2;
            color: #991b1b;
            padding: 12px;
            border-radius: 6px;
            margin-top: 15px;
        }

        .yaml-editor {
            width: 100%;
            min-height: 400px;
            font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
            font-size: 14px;
            padding: 12px;
            border: 1px solid #e5e7eb;
            border-radius: 6px;
            resize: vertical;
        }

        .execute-actions {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }

        .execute-actions button {
            background: #667eea;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            transition: background 0.3s;
            flex: 1;
        }

        .execute-actions button:hover {
            background: #5568d3;
        }

        .execute-actions button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }

        .execute-actions button.secondary {
            background: #f0f0f0;
            color: #333;
        }

        .execute-actions button.secondary:hover {
            background: #e0e0e0;
        }

        .execution-logs {
            background: #1f2937;
            color: #e5e7eb;
            padding: 15px;
            border-radius: 6px;
            font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
            font-size: 13px;
            line-height: 1.6;
            max-height: 300px;
            overflow-y: auto;
            margin-top: 15px;
            display: none;
        }

        .execution-logs.active {
            display: block;
        }

        .execution-status {
            padding: 10px;
            border-radius: 6px;
            margin-top: 15px;
            font-weight: 500;
        }

        .execution-status.running {
            background: #dbeafe;
            color: #1e40af;
        }

        .execution-status.succeeded {
            background: #d1fae5;
            color: #065f46;
        }

        .execution-status.failed {
            background: #fee2e2;
            color: #991b1b;
        }

        /* Drawer æ ·å¼ */
        .drawer {
            position: fixed;
            top: 0;
            right: 0;
            width: 0;
            height: 100%;
            background: white;
            box-shadow: -2px 0 10px rgba(0,0,0,0.1);
            z-index: 1000;
            transition: width 0.3s ease;
            overflow: hidden;
        }

        .drawer.active {
            width: 50%;
            min-width: 600px;
            max-width: 1200px;
        }

        .drawer-content {
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .drawer-header {
            padding: 20px;
            border-bottom: 1px solid #e5e7eb;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-shrink: 0;
        }

        .drawer-header h2 {
            font-size: 20px;
            color: #1f2937;
            margin: 0;
        }

        .drawer-close {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #6b7280;
            padding: 0;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .drawer-close:hover {
            color: #1f2937;
        }

        .drawer-body {
            padding: 20px;
            overflow-y: auto;
            flex: 1;
        }

        .drawer-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 999;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease, visibility 0.3s ease;
        }

        .drawer-overlay.active {
            opacity: 1;
            visibility: visible;
        }

        @media (max-width: 768px) {
            .drawer.active {
                width: 100%;
                min-width: 100%;
            }
        }

        .queue-stats {
            background: white;
            padding: 15px 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 15px;
        }

        .queue-stats-title {
            font-size: 16px;
            font-weight: 600;
            color: #1f2937;
        }

        .queue-stats-items {
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
        }

        .queue-stat-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            min-width: 80px;
        }

        .queue-stat-label {
            font-size: 12px;
            color: #6b7280;
            margin-bottom: 4px;
        }

        .queue-stat-value {
            font-size: 20px;
            font-weight: 600;
            color: #1f2937;
        }

        .queue-stat-value.pending {
            color: #f59e0b;
        }

        .queue-stat-value.running {
            color: #667eea;
        }

        .queue-stat-value.succeeded {
            color: #10b981;
        }

        .queue-stat-value.failed {
            color: #ef4444;
        }

        /* Notification æ ·å¼ */
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background: white;
            padding: 16px 20px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            z-index: 2000;
            display: flex;
            align-items: center;
            gap: 12px;
            min-width: 300px;
            max-width: 500px;
            animation: slideInRight 0.3s ease;
            border-left: 4px solid #10b981;
        }

        .notification.success {
            border-left-color: #10b981;
        }

        .notification.error {
            border-left-color: #ef4444;
        }

        .notification.warning {
            border-left-color: #f59e0b;
        }

        .notification.info {
            border-left-color: #667eea;
        }

        .notification-icon {
            font-size: 24px;
            flex-shrink: 0;
        }

        .notification-content {
            flex: 1;
        }

        .notification-title {
            font-weight: 600;
            color: #1f2937;
            margin-bottom: 4px;
        }

        .notification-message {
            font-size: 14px;
            color: #6b7280;
        }

        .notification-close {
            background: none;
            border: none;
            font-size: 20px;
            cursor: pointer;
            color: #9ca3af;
            padding: 0;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }

        .notification-close:hover {
            color: #1f2937;
        }

        @keyframes slideInRight {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        @keyframes slideOutRight {
            from {
                transform: translateX(0);
                opacity: 1;
            }
            to {
                transform: translateX(100%);
                opacity: 0;
            }
        }

        .notification.hiding {
            animation: slideOutRight 0.3s ease;
        }

        /* æœç´¢å’Œè¿‡æ»¤æ ·å¼ */
        .search-bar {
            display: flex;
            gap: 10px;
            align-items: center;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }

        .search-input {
            flex: 1;
            min-width: 200px;
            padding: 10px 15px;
            border: 1px solid #e5e7eb;
            border-radius: 6px;
            font-size: 14px;
        }

        .search-input:focus {
            outline: none;
            border-color: #667eea;
        }

        .time-range-selector {
            padding: 10px 15px;
            border: 1px solid #e5e7eb;
            border-radius: 6px;
            font-size: 14px;
            background: white;
            cursor: pointer;
        }

        .time-range-selector:focus {
            outline: none;
            border-color: #667eea;
        }

        /* æ—¥å¿—å¢å¼ºæ ·å¼ */
        .log-toolbar {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
            flex-wrap: wrap;
            align-items: center;
        }

        .log-search-input {
            flex: 1;
            min-width: 200px;
            padding: 8px 12px;
            border: 1px solid #e5e7eb;
            border-radius: 4px;
            font-size: 13px;
        }

        .log-type-filter {
            display: flex;
            gap: 5px;
        }

        .log-type-filter button {
            padding: 6px 12px;
            border: 1px solid #e5e7eb;
            background: white;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
        }

        .log-type-filter button.active {
            background: #667eea;
            color: white;
            border-color: #667eea;
        }

        .log-entry.highlight {
            background: rgba(255, 255, 0, 0.2);
        }

        .log-entry mark {
            background: rgba(255, 255, 0, 0.4);
            padding: 0 2px;
        }

        /* æ·±è‰²æ¨¡å¼ */
        :root {
            --bg-primary: #f5f5f5;
            --bg-secondary: white;
            --text-primary: #333;
            --text-secondary: #6b7280;
            --border-color: #e5e7eb;
            --header-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }

        body.dark-mode {
            --bg-primary: #1f2937;
            --bg-secondary: #374151;
            --text-primary: #e5e7eb;
            --text-secondary: #9ca3af;
            --border-color: #4b5563;
            --header-gradient: linear-gradient(135deg, #4b5563 0%, #1f2937 100%);
        }

        body.dark-mode {
            background: var(--bg-primary);
            color: var(--text-primary);
        }

        body.dark-mode .toolbar,
        body.dark-mode .pipeline-card,
        body.dark-mode .queue-stats,
        body.dark-mode .drawer,
        body.dark-mode .form-input,
        body.dark-mode .search-input,
        body.dark-mode .time-range-selector {
            background: var(--bg-secondary);
            color: var(--text-primary);
            border-color: var(--border-color);
        }

        body.dark-mode header {
            background: var(--header-gradient);
        }

        body.dark-mode .pipeline-name,
        body.dark-mode .detail-value,
        body.dark-mode .pipeline-info-value {
            color: var(--text-primary);
        }

        body.dark-mode .pipeline-info-label,
        body.dark-mode .detail-label,
        body.dark-mode .pipeline-id {
            color: var(--text-secondary);
        }

        .theme-toggle {
            background: none;
            border: none;
            font-size: 20px;
            cursor: pointer;
            padding: 5px 10px;
            border-radius: 4px;
            transition: background 0.2s;
        }

        .theme-toggle:hover {
            background: rgba(0, 0, 0, 0.1);
        }

        body.dark-mode .theme-toggle:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        /* å®æ—¶æ—¥å¿—æ ·å¼ */
        .realtime-log-toggle {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 12px;
            background: #f0f0f0;
            border-radius: 4px;
            cursor: pointer;
            font-size: 13px;
        }

        body.dark-mode .realtime-log-toggle {
            background: #4b5563;
        }

        .realtime-log-toggle input[type="checkbox"] {
            cursor: pointer;
        }

        .realtime-log-indicator {
            display: inline-block;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #ef4444;
            margin-left: 5px;
            animation: pulse 2s infinite;
        }

        .realtime-log-indicator.active {
            background: #10b981;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        /* å¯è§†åŒ–ç¼–è¾‘å™¨æ ·å¼ */
        .editor-mode-switch {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            border-bottom: 2px solid #e5e7eb;
        }

        .mode-btn {
            padding: 10px 20px;
            background: none;
            border: none;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            color: #6b7280;
            border-bottom: 2px solid transparent;
            margin-bottom: -2px;
            transition: color 0.3s;
        }

        .mode-btn:hover {
            color: #1f2937;
        }

        .mode-btn.active {
            color: #667eea;
            border-bottom-color: #667eea;
        }

        .editor-container {
            display: none;
        }

        .editor-container.active {
            display: block;
        }

        .visual-editor {
            background: white;
            padding: 20px;
            border-radius: 8px;
            border: 1px solid #e5e7eb;
        }

        .visual-section {
            margin-bottom: 25px;
            padding: 15px;
            background: #f9fafb;
            border-radius: 6px;
            border: 1px solid #e5e7eb;
        }

        .visual-section-title {
            font-size: 16px;
            font-weight: 600;
            color: #1f2937;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .stage-item, .job-item, .step-item {
            margin-bottom: 15px;
            padding: 15px;
            background: white;
            border-radius: 6px;
            border: 1px solid #e5e7eb;
            position: relative;
        }

        .stage-item {
            border-left: 3px solid #667eea;
        }

        .job-item {
            border-left: 3px solid #10b981;
            margin-left: 20px;
        }

        .step-item {
            border-left: 3px solid #f59e0b;
            margin-left: 40px;
        }

        .item-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .item-title {
            font-weight: 600;
            color: #1f2937;
        }

        .item-actions {
            display: flex;
            gap: 10px;
        }

        .btn-small {
            padding: 6px 12px;
            font-size: 12px;
            border-radius: 4px;
            border: none;
            cursor: pointer;
            transition: background 0.2s;
        }

        .btn-add {
            background: #10b981;
            color: white;
        }

        .btn-add:hover {
            background: #059669;
        }

        .btn-remove {
            background: #ef4444;
            color: white;
        }

        .btn-remove:hover {
            background: #dc2626;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 15px;
        }

        .form-row.full {
            grid-template-columns: 1fr;
        }

        .required {
            color: #ef4444;
        }

        .env-vars-editor {
            min-height: 100px;
            font-family: monospace;
            font-size: 13px;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>ğŸš€ Pipeline Console</h1>
        </header>

        <div class="toolbar">
            <div style="display: flex; gap: 10px; align-items: center; flex-wrap: wrap;">
                <button onclick="showRunPipeline()" style="background: #10b981;">â• æ–°å»º Pipeline</button>
                <button onclick="refreshPipelines()">ğŸ”„ åˆ·æ–°</button>
                <button onclick="clearFilter()">æ¸…é™¤ç­›é€‰</button>
                <button onclick="showSettings()" style="background: #6b7280;">âš™ï¸ è®¾ç½®</button>
                <button class="theme-toggle" onclick="toggleTheme()" title="åˆ‡æ¢ä¸»é¢˜">ğŸŒ“</button>
            </div>
            <div class="status-filter">
                <button onclick="filterByStatus('all')" class="active" id="filter-all">å…¨éƒ¨</button>
                <button onclick="filterByStatus('pending')" id="filter-pending">ç­‰å¾…ä¸­</button>
                <button onclick="filterByStatus('running')" id="filter-running">è¿è¡Œä¸­</button>
                <button onclick="filterByStatus('succeeded')" id="filter-succeeded">æˆåŠŸ</button>
                <button onclick="filterByStatus('failed')" id="filter-failed">å¤±è´¥</button>
                <button onclick="filterByStatus('cancelled')" id="filter-cancelled">å·²å–æ¶ˆ</button>
            </div>
        </div>

        <!-- æœç´¢æ  -->
        <div class="search-bar">
            <input type="text" id="search-input" class="search-input" placeholder="æœç´¢ Pipeline (åç§°æˆ–ID)..." oninput="handleSearch()">
            <select id="time-range-selector" class="time-range-selector" onchange="handleTimeRangeChange()">
                <option value="">å…¨éƒ¨æ—¶é—´</option>
                <option value="today">ä»Šå¤©</option>
                <option value="week">æœ¬å‘¨</option>
                <option value="month">æœ¬æœˆ</option>
                <option value="custom">è‡ªå®šä¹‰</option>
            </select>
            <div id="custom-time-range" style="display: none; gap: 10px; align-items: center;">
                <input type="datetime-local" id="start-time" class="form-input" style="width: auto;">
                <span>è‡³</span>
                <input type="datetime-local" id="end-time" class="form-input" style="width: auto;">
                <button onclick="applyCustomTimeRange()" style="padding: 8px 15px;">åº”ç”¨</button>
            </div>
        </div>

        <!-- é˜Ÿåˆ—ç»Ÿè®¡ -->
        <div class="queue-stats" id="queue-stats">
            <div class="queue-stats-title">ğŸ“Š é˜Ÿåˆ—çŠ¶æ€</div>
            <div class="queue-stats-items">
                <div class="queue-stat-item">
                    <div class="queue-stat-label">æ€»ä»»åŠ¡</div>
                    <div class="queue-stat-value" id="stat-total">-</div>
                </div>
                <div class="queue-stat-item">
                    <div class="queue-stat-label">ç­‰å¾…ä¸­</div>
                    <div class="queue-stat-value pending" id="stat-pending">-</div>
                </div>
                <div class="queue-stat-item">
                    <div class="queue-stat-label">è¿è¡Œä¸­</div>
                    <div class="queue-stat-value running" id="stat-running">-</div>
                </div>
                <div class="queue-stat-item">
                    <div class="queue-stat-label">æˆåŠŸ</div>
                    <div class="queue-stat-value succeeded" id="stat-succeeded">-</div>
                </div>
                <div class="queue-stat-item">
                    <div class="queue-stat-label">å¤±è´¥</div>
                    <div class="queue-stat-value failed" id="stat-failed">-</div>
                </div>
                <div class="queue-stat-item">
                    <div class="queue-stat-label">å·²å–æ¶ˆ</div>
                    <div class="queue-stat-value" id="stat-cancelled">-</div>
                </div>
                <div class="queue-stat-item">
                    <div class="queue-stat-label">å¹¶å‘æ•°</div>
                    <div class="queue-stat-value" id="stat-concurrent">- / -</div>
                </div>
            </div>
        </div>

        <div id="pipelines-container">
            <div class="loading">
                <div class="spinner"></div>
                <div>åŠ è½½ä¸­...</div>
            </div>
        </div>
    </div>

    <!-- Notification å®¹å™¨ -->
    <div id="notification-container"></div>

    <!-- Pipeline è¯¦æƒ… Drawer -->
    <div id="pipeline-drawer" class="drawer">
        <div class="drawer-content">
            <div class="drawer-header">
                <h2 id="drawer-title">Pipeline è¯¦æƒ…</h2>
                <button class="drawer-close" onclick="closePipelineDrawer()">&times;</button>
            </div>
            <div class="drawer-body">
                <div id="drawer-content">
                    <div class="loading">
                        <div class="spinner"></div>
                        <div>åŠ è½½ä¸­...</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Drawer Overlay -->
    <div id="drawer-overlay" class="drawer-overlay" onclick="closeAllDrawers()"></div>
    
    <!-- è®¾ç½® Drawer -->
    <div id="settings-drawer" class="drawer">
        <div class="drawer-content">
            <div class="drawer-header">
                <h2>ç³»ç»Ÿè®¾ç½®</h2>
                <button class="drawer-close" onclick="closeSettingsDrawer()">&times;</button>
            </div>
            <div class="drawer-body">
                <div class="settings-form">
                    <div class="form-group">
                        <label class="form-label">é˜Ÿåˆ—æœ€å¤§å¹¶å‘æ•°</label>
                        <input type="number" id="setting-max-concurrent" class="form-input" min="1" value="2">
                        <div class="form-help">åŒæ—¶æ‰§è¡Œçš„æœ€å¤§ pipeline æ•°é‡ï¼ˆé»˜è®¤: 2ï¼Œéœ€è¦é‡å¯æœåŠ¡ç”Ÿæ•ˆï¼‰</div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">å†å²è®°å½•ä¿ç•™æ•°é‡</label>
                        <input type="number" id="setting-max-records" class="form-input" min="1" value="1000">
                        <div class="form-help">æœ€å¤šä¿ç•™çš„å†å² pipeline è®°å½•æ•°é‡ï¼ˆé»˜è®¤: 1000ï¼‰</div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">è‡ªåŠ¨åˆ·æ–°é—´éš”ï¼ˆç§’ï¼‰</label>
                        <input type="number" id="setting-refresh-interval" class="form-input" min="1" value="5">
                        <div class="form-help">Web Console è‡ªåŠ¨åˆ·æ–°é—´éš”ï¼ˆé»˜è®¤: 5ç§’ï¼‰</div>
                    </div>
                    <div class="execute-actions">
                        <button onclick="saveSettings()">ğŸ’¾ ä¿å­˜è®¾ç½®</button>
                        <button onclick="closeSettingsDrawer()" class="secondary">å–æ¶ˆ</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- åˆ›å»º Pipeline Drawer -->
    <div id="run-pipeline-drawer" class="drawer">
        <div class="drawer-content">
            <div class="drawer-header">
                <h2>åˆ›å»º Pipeline</h2>
                <button class="drawer-close" onclick="closeRunDrawer()">&times;</button>
            </div>
            <div class="drawer-body">
                <div>
                    <!-- æ¨¡å¼åˆ‡æ¢ -->
                    <div class="editor-mode-switch">
                        <button class="mode-btn active" id="mode-visual" onclick="switchEditorMode('visual')">ğŸ“ å¯è§†åŒ–ç¼–è¾‘</button>
                        <button class="mode-btn" id="mode-yaml" onclick="switchEditorMode('yaml')">ğŸ“„ YAML ç¼–è¾‘</button>
                    </div>

                    <!-- å¯è§†åŒ–ç¼–è¾‘å™¨ -->
                    <div id="visual-editor-container" class="editor-container active">
                        <div class="visual-editor" id="visual-editor">
                            <!-- åŠ¨æ€ç”Ÿæˆ -->
                        </div>
                    </div>

                    <!-- YAML ç¼–è¾‘å™¨ -->
                    <div id="yaml-editor-container" class="editor-container">
                        <label style="display: block; margin-bottom: 8px; font-weight: 500;">Pipeline é…ç½® (YAML):</label>
                        <textarea id="pipeline-yaml" class="yaml-editor" placeholder="è¯·è¾“å…¥ pipeline YAML é…ç½®..." oninput="syncYAMLToVisual()"></textarea>
                    </div>

                    <div class="execute-actions" style="margin-top: 20px;">
                        <button onclick="createPipeline()" id="create-btn">â• åˆ›å»º</button>
                        <button onclick="syncVisualToYAML()" id="sync-btn" class="secondary" style="display: none;">ğŸ”„ åŒæ­¥åˆ° YAML</button>
                        <button onclick="closeRunDrawer()" class="secondary">å–æ¶ˆ</button>
                    </div>
                    <div id="creation-status" class="execution-status" style="display: none;"></div>
                    <div id="creation-message" style="margin-top: 15px; padding: 12px; background: #f0f9ff; border-radius: 6px; color: #1e40af; font-size: 14px;">
                        ğŸ’¡ Pipeline å°†è¢«æ·»åŠ åˆ°æ‰§è¡Œé˜Ÿåˆ—ï¼Œé˜Ÿåˆ—ä¼šåœ¨åå°è‡ªåŠ¨æ£€æµ‹å¹¶æ‰§è¡Œã€‚æ‚¨å¯ä»¥åœ¨ Pipeline åˆ—è¡¨ä¸­æŸ¥çœ‹æ‰§è¡ŒçŠ¶æ€ã€‚
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const API_BASE = '/api/v1';
        let allPipelines = [];
        let currentFilter = 'all';
        let searchQuery = '';
        let timeRange = '';
        let startTime = null;
        let endTime = null;
        let currentPipelineId = null;
        let logWebSocket = null;
        let realtimeLogEnabled = false;

        // é¡µé¢åŠ è½½æ—¶è·å– pipeline åˆ—è¡¨å’Œé˜Ÿåˆ—çŠ¶æ€
        document.addEventListener('DOMContentLoaded', () => {
            // åŠ è½½ä¸»é¢˜åå¥½
            loadTheme();
            refreshPipelines();
            refreshQueueStats();
            // æ¯5ç§’è‡ªåŠ¨åˆ·æ–°
            window.refreshInterval = setInterval(() => {
                refreshPipelines();
                refreshQueueStats();
            }, 5000);
        });

        // è·å– pipeline åˆ—è¡¨
        async function refreshPipelines() {
            try {
                const params = new URLSearchParams();
                params.append('limit', '100');
                if (searchQuery) {
                    params.append('search', searchQuery);
                }
                if (currentFilter !== 'all') {
                    params.append('status', currentFilter);
                }
                if (startTime) {
                    params.append('start_time', startTime.toISOString());
                }
                if (endTime) {
                    params.append('end_time', endTime.toISOString());
                }

                const response = await fetch(`${API_BASE}/pipelines?${params.toString()}`);
                const data = await response.json();
                allPipelines = data.data || [];
                renderPipelines();
            } catch (error) {
                console.error('Failed to fetch pipelines:', error);
                document.getElementById('pipelines-container').innerHTML = `
                    <div class="empty-state">
                        <div>âŒ åŠ è½½å¤±è´¥: ${error.message}</div>
                    </div>
                `;
            }
        }

        // è·å–é˜Ÿåˆ—ç»Ÿè®¡ä¿¡æ¯
        async function refreshQueueStats() {
            try {
                const response = await fetch(`${API_BASE}/queue/stats`);
                const stats = await response.json();
                
                document.getElementById('stat-total').textContent = stats.total || 0;
                document.getElementById('stat-pending').textContent = stats.pending || 0;
                document.getElementById('stat-running').textContent = stats.running || 0;
                document.getElementById('stat-succeeded').textContent = stats.succeeded || 0;
                document.getElementById('stat-failed').textContent = stats.failed || 0;
                const cancelledEl = document.getElementById('stat-cancelled');
                if (cancelledEl) {
                    cancelledEl.textContent = stats.cancelled || 0;
                }
                document.getElementById('stat-concurrent').textContent = 
                    `${stats.current_concurrent || 0} / ${stats.max_concurrent || 0}`;
            } catch (error) {
                console.error('Failed to fetch queue stats:', error);
            }
        }

        // æ¸²æŸ“ pipeline åˆ—è¡¨
        function renderPipelines() {
            const container = document.getElementById('pipelines-container');
            const filtered = filterPipelines();

            if (filtered.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
                        </svg>
                        <h3>æš‚æ—  Pipeline</h3>
                        <p>å½“å‰æ²¡æœ‰æ‰¾åˆ°ç¬¦åˆæ¡ä»¶çš„ pipeline è®°å½•</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = `
                <div class="pipelines-grid">
                    ${filtered.map(p => createPipelineCard(p)).join('')}
                </div>
            `;
        }

        // åˆ›å»º pipeline å¡ç‰‡
        function createPipelineCard(pipeline) {
            const duration = getDuration(pipeline);
            const startedAt = formatTime(pipeline.started_at);
            const canCancel = pipeline.status === 'pending' || pipeline.status === 'running';
            
            return `
                <div class="pipeline-card ${pipeline.status}" onclick="showPipelineDetails('${pipeline.id}')">
                    <div class="pipeline-header">
                        <div style="flex: 1; min-width: 0;">
                            <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 5px;">
                                <span class="pipeline-status ${pipeline.status}">${pipeline.status}</span>
                                <div class="pipeline-name">${escapeHtml(pipeline.name || 'Unnamed')}</div>
                                ${canCancel ? `
                                    <button onclick="event.stopPropagation(); cancelPipeline('${pipeline.id}')" 
                                            class="cancel-btn" style="margin-left: auto;">
                                        âŒ å–æ¶ˆ
                                    </button>
                                ` : ''}
                            </div>
                            <div class="pipeline-id">${pipeline.id}</div>
                        </div>
                    </div>
                    <div class="pipeline-info">
                        <div class="pipeline-info-item">
                            <span class="pipeline-info-label">å¼€å§‹æ—¶é—´:</span>
                            <span class="pipeline-info-value">${startedAt}</span>
                        </div>
                        <div class="pipeline-info-item">
                            <span class="pipeline-info-label">è¿è¡Œæ—¶é•¿:</span>
                            <span class="pipeline-info-value">${duration}</span>
                        </div>
                        ${pipeline.succeed_at ? `
                            <div class="pipeline-info-item">
                                <span class="pipeline-info-label">å®Œæˆæ—¶é—´:</span>
                                <span class="pipeline-info-value">${formatTime(pipeline.succeed_at)}</span>
                            </div>
                        ` : ''}
                        ${pipeline.failed_at ? `
                            <div class="pipeline-info-item">
                                <span class="pipeline-info-label">å¤±è´¥æ—¶é—´:</span>
                                <span class="pipeline-info-value">${formatTime(pipeline.failed_at)}</span>
                            </div>
                        ` : ''}
                        ${pipeline.cancelled_at ? `
                            <div class="pipeline-info-item">
                                <span class="pipeline-info-label">å–æ¶ˆæ—¶é—´:</span>
                                <span class="pipeline-info-value">${formatTime(pipeline.cancelled_at)}</span>
                            </div>
                        ` : ''}
                    </div>
                </div>
            `;
        }

        // ç­›é€‰ pipeline
        function filterPipelines() {
            // åç«¯å·²ç»å¤„ç†äº†è¿‡æ»¤ï¼Œè¿™é‡Œç›´æ¥è¿”å›
                return allPipelines;
            }

        // æœç´¢å¤„ç†
        function handleSearch() {
            searchQuery = document.getElementById('search-input').value.trim();
            refreshPipelines();
        }

        // æ—¶é—´èŒƒå›´å¤„ç†
        function handleTimeRangeChange() {
            const selector = document.getElementById('time-range-selector');
            timeRange = selector.value;
            const customRange = document.getElementById('custom-time-range');
            
            if (timeRange === 'custom') {
                customRange.style.display = 'flex';
            } else {
                customRange.style.display = 'none';
                const now = new Date();
                startTime = null;
                endTime = null;
                
                if (timeRange === 'today') {
                    startTime = new Date(now.getFullYear(), now.getMonth(), now.getDate());
                    endTime = now;
                } else if (timeRange === 'week') {
                    const dayOfWeek = now.getDay();
                    const diff = now.getDate() - dayOfWeek;
                    startTime = new Date(now.getFullYear(), now.getMonth(), diff);
                    endTime = now;
                } else if (timeRange === 'month') {
                    startTime = new Date(now.getFullYear(), now.getMonth(), 1);
                    endTime = now;
                }
                
                refreshPipelines();
            }
        }

        // åº”ç”¨è‡ªå®šä¹‰æ—¶é—´èŒƒå›´
        function applyCustomTimeRange() {
            const startInput = document.getElementById('start-time').value;
            const endInput = document.getElementById('end-time').value;
            
            if (startInput) {
                startTime = new Date(startInput);
            } else {
                startTime = null;
            }
            
            if (endInput) {
                endTime = new Date(endInput);
            } else {
                endTime = null;
            }
            
            refreshPipelines();
        }

        // æ·±è‰²æ¨¡å¼
        function toggleTheme() {
            document.body.classList.toggle('dark-mode');
            saveTheme();
        }

        function loadTheme() {
            const theme = localStorage.getItem('pipeline-console-theme');
            if (theme === 'dark') {
                document.body.classList.add('dark-mode');
            }
        }

        function saveTheme() {
            const isDark = document.body.classList.contains('dark-mode');
            localStorage.setItem('pipeline-console-theme', isDark ? 'dark' : 'light');
        }

        // æŒ‰çŠ¶æ€ç­›é€‰
        function filterByStatus(status) {
            currentFilter = status;
            
            // æ›´æ–°æŒ‰é’®çŠ¶æ€
            document.querySelectorAll('.status-filter button').forEach(btn => {
                btn.classList.remove('active');
            });
            document.getElementById(`filter-${status}`).classList.add('active');
            
            renderPipelines();
        }

        // æ¸…é™¤ç­›é€‰
        function clearFilter() {
            filterByStatus('all');
            document.getElementById('search-input').value = '';
            searchQuery = '';
            document.getElementById('time-range-selector').value = '';
            timeRange = '';
            startTime = null;
            endTime = null;
            document.getElementById('custom-time-range').style.display = 'none';
            refreshPipelines();
        }

        // æ˜¾ç¤º pipeline è¯¦æƒ…
        async function showPipelineDetails(id) {
            currentPipelineId = id;
            const drawer = document.getElementById('pipeline-drawer');
            const content = document.getElementById('drawer-content');
            
            document.getElementById('drawer-overlay').classList.add('active');
            drawer.classList.add('active');
            content.innerHTML = `
                <div class="loading">
                    <div class="spinner"></div>
                    <div>åŠ è½½ä¸­...</div>
                </div>
            `;

            // å…³é—­ä¹‹å‰çš„å®æ—¶æ—¥å¿—è¿æ¥
            if (logWebSocket) {
                logWebSocket.close();
                logWebSocket = null;
            }
            realtimeLogEnabled = false;

            try {
                const response = await fetch(`${API_BASE}/pipelines/${id}`);
                const pipeline = await response.json();

                document.getElementById('drawer-title').textContent = `${pipeline.name || 'Unnamed'} - ${pipeline.id}`;
                
                await renderPipelineDetails(pipeline);
            } catch (error) {
                content.innerHTML = `
                    <div class="empty-state">
                        <div>âŒ åŠ è½½å¤±è´¥: ${error.message}</div>
                    </div>
                `;
            }
        }

        // æ¸²æŸ“ Pipeline è¯¦æƒ…
        async function renderPipelineDetails(pipeline) {
            const content = document.getElementById('drawer-content');
            
            // è·å–æ—¥å¿—
            let logs = pipeline.logs || [];
            const logSearchQuery = document.getElementById('log-search-input')?.value || '';
            const logTypeFilter = window.currentLogTypeFilter || '';
            
            if (logSearchQuery || logTypeFilter) {
                const params = new URLSearchParams();
                if (logSearchQuery) params.append('search', logSearchQuery);
                if (logTypeFilter) params.append('type', logTypeFilter);
                
                const logResponse = await fetch(`${API_BASE}/pipelines/${pipeline.id}/logs?${params.toString()}`);
                const logData = await logResponse.json();
                logs = logData.data || [];
            }
                
                content.innerHTML = `
                    <div class="pipeline-details">
                        <div class="detail-row">
                            <div class="detail-label">çŠ¶æ€:</div>
                            <div class="detail-value">
                                <span class="pipeline-status ${pipeline.status}">${pipeline.status}</span>
                            </div>
                        </div>
                        <div class="detail-row">
                            <div class="detail-label">å¼€å§‹æ—¶é—´:</div>
                            <div class="detail-value">${formatTime(pipeline.started_at)}</div>
                        </div>
                        ${pipeline.succeed_at ? `
                            <div class="detail-row">
                                <div class="detail-label">å®Œæˆæ—¶é—´:</div>
                                <div class="detail-value">${formatTime(pipeline.succeed_at)}</div>
                            </div>
                        ` : ''}
                        ${pipeline.failed_at ? `
                            <div class="detail-row">
                                <div class="detail-label">å¤±è´¥æ—¶é—´:</div>
                                <div class="detail-value">${formatTime(pipeline.failed_at)}</div>
                            </div>
                        ` : ''}
                        ${pipeline.cancelled_at ? `
                            <div class="detail-row">
                                <div class="detail-label">å–æ¶ˆæ—¶é—´:</div>
                                <div class="detail-value">${formatTime(pipeline.cancelled_at)}</div>
                            </div>
                        ` : ''}
                        <div class="detail-row">
                            <div class="detail-label">è¿è¡Œæ—¶é•¿:</div>
                            <div class="detail-value">${getDuration(pipeline)}</div>
                        </div>
                        ${pipeline.error ? `
                            <div class="error-message">
                                <strong>é”™è¯¯ä¿¡æ¯:</strong><br>
                                ${escapeHtml(pipeline.error)}
                            </div>
                        ` : ''}
                    </div>
                    <div class="tabs">
                        <div class="tab active" onclick="switchTab('logs')">æ—¥å¿—</div>
                        <div class="tab" onclick="switchTab('yaml')">Pipeline å®šä¹‰</div>
                    </div>
                    <div id="tab-logs" class="tab-content active">
                    <div class="log-toolbar">
                        <input type="text" id="log-search-input" class="log-search-input" placeholder="æœç´¢æ—¥å¿—..." oninput="filterLogs()" value="${logSearchQuery}">
                        <div class="log-type-filter">
                            <button onclick="setLogTypeFilter('')" class="${logTypeFilter === '' ? 'active' : ''}" id="log-filter-all">å…¨éƒ¨</button>
                            <button onclick="setLogTypeFilter('stdout')" class="${logTypeFilter === 'stdout' ? 'active' : ''}" id="log-filter-stdout">stdout</button>
                            <button onclick="setLogTypeFilter('stderr')" class="${logTypeFilter === 'stderr' ? 'active' : ''}" id="log-filter-stderr">stderr</button>
                            <button onclick="setLogTypeFilter('status')" class="${logTypeFilter === 'status' ? 'active' : ''}" id="log-filter-status">status</button>
                                    </div>
                        <button onclick="exportLogs('text')" style="padding: 8px 15px; background: #3b82f6; color: white; border: none; border-radius: 4px; cursor: pointer;">ğŸ“¥ å¯¼å‡º TXT</button>
                        <button onclick="exportLogs('json')" style="padding: 8px 15px; background: #3b82f6; color: white; border: none; border-radius: 4px; cursor: pointer;">ğŸ“¥ å¯¼å‡º JSON</button>
                        <label class="realtime-log-toggle">
                            <input type="checkbox" id="realtime-log-toggle" onchange="toggleRealtimeLogs()" ${pipeline.status === 'running' ? '' : 'disabled'}>
                            <span>å®æ—¶æ—¥å¿—</span>
                            <span class="realtime-log-indicator" id="realtime-indicator"></span>
                        </label>
                    </div>
                    <div class="logs-container" id="logs-container">
                        ${renderLogs(logs, logSearchQuery)}
                        </div>
                    </div>
                    <div id="tab-yaml" class="tab-content">
                        <div class="yaml-container">
                            ${pipeline.yaml ? `
                                <button class="copy-yaml-btn" onclick="copyPipelineYAML('${pipeline.id}', this)" title="å¤åˆ¶ Pipeline å®šä¹‰">
                                    ğŸ“‹ å¤åˆ¶
                                </button>
                            ` : ''}
                            <div class="yaml-viewer">${pipeline.yaml ? escapeHtml(pipeline.yaml) : '<div style="color: #6b7280;">æš‚æ—  Pipeline å®šä¹‰</div>'}</div>
                        </div>
                    </div>
                `;

                // æ»šåŠ¨åˆ°åº•éƒ¨
                const logsContainer = document.getElementById('logs-container');
                if (logsContainer) {
                    logsContainer.scrollTop = logsContainer.scrollHeight;
            }
        }

        // æ¸²æŸ“æ—¥å¿—
        function renderLogs(logs, searchQuery = '') {
            if (logs.length === 0) {
                return '<div style="color: #6b7280;">æš‚æ— æ—¥å¿—</div>';
            }
            
            return logs.map(log => {
                let message = escapeHtml(log.message);
                if (searchQuery) {
                    const regex = new RegExp(`(${escapeRegex(searchQuery)})`, 'gi');
                    message = message.replace(regex, '<mark>$1</mark>');
                }
                return `<div class="log-entry ${log.type}">[${formatTime(log.timestamp)}] ${message}</div>`;
            }).join('');
        }

        // è¿‡æ»¤æ—¥å¿—
        async function filterLogs() {
            if (!currentPipelineId) return;
            
            const searchQuery = document.getElementById('log-search-input').value;
            const typeFilter = window.currentLogTypeFilter || '';
            
            const params = new URLSearchParams();
            if (searchQuery) params.append('search', searchQuery);
            if (typeFilter) params.append('type', typeFilter);
            
            try {
                const response = await fetch(`${API_BASE}/pipelines/${currentPipelineId}/logs?${params.toString()}`);
                const data = await response.json();
                const logsContainer = document.getElementById('logs-container');
                if (logsContainer) {
                    logsContainer.innerHTML = renderLogs(data.data || [], searchQuery);
                }
            } catch (error) {
                console.error('Failed to filter logs:', error);
            }
        }

        // è®¾ç½®æ—¥å¿—ç±»å‹è¿‡æ»¤
        function setLogTypeFilter(type) {
            window.currentLogTypeFilter = type;
            
            // æ›´æ–°æŒ‰é’®çŠ¶æ€
            document.querySelectorAll('.log-type-filter button').forEach(btn => {
                btn.classList.remove('active');
            });
            document.getElementById(`log-filter-${type || 'all'}`).classList.add('active');
            
            filterLogs();
        }

        // å¯¼å‡ºæ—¥å¿—
        async function exportLogs(format) {
            if (!currentPipelineId) return;
            
            const searchQuery = document.getElementById('log-search-input')?.value || '';
            const typeFilter = window.currentLogTypeFilter || '';
            
            const params = new URLSearchParams();
            params.append('format', format);
            if (searchQuery) params.append('search', searchQuery);
            if (typeFilter) params.append('type', typeFilter);
            
            const url = `${API_BASE}/pipelines/${currentPipelineId}/logs/export?${params.toString()}`;
            window.open(url, '_blank');
        }

        // åˆ‡æ¢å®æ—¶æ—¥å¿—
        function toggleRealtimeLogs() {
            const toggle = document.getElementById('realtime-log-toggle');
            realtimeLogEnabled = toggle.checked;
            const indicator = document.getElementById('realtime-indicator');
            
            if (realtimeLogEnabled) {
                indicator.classList.add('active');
                connectRealtimeLogs();
            } else {
                indicator.classList.remove('active');
                if (logWebSocket) {
                    logWebSocket.close();
                    logWebSocket = null;
                }
            }
        }

        // è¿æ¥å®æ—¶æ—¥å¿—
        function connectRealtimeLogs() {
            if (!currentPipelineId) return;
            
            const wsProtocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
            const wsPath = window.location.pathname.replace('/console', '') || '/';
            const wsURL = `${wsProtocol}//${window.location.host}${wsPath}`;
            
            try {
                logWebSocket = new WebSocket(wsURL);
                
                logWebSocket.onopen = () => {
                    // è®¢é˜…æ—¥å¿—æµ
                    logWebSocket.send(JSON.stringify({
                        type: 'subscribe_logs',
                        pipeline_id: currentPipelineId
                    }));
                };
                
                logWebSocket.onmessage = (event) => {
                    try {
                        const msg = JSON.parse(event.data);
                        if (msg.type === 'log' && msg.pipeline_id === currentPipelineId) {
                            appendLogEntry(msg.log);
                        }
                    } catch (error) {
                        // å¿½ç•¥è§£æé”™è¯¯
                    }
                };
                
                logWebSocket.onerror = (error) => {
                    console.error('WebSocket error:', error);
                    showNotification('error', 'å®æ—¶æ—¥å¿—è¿æ¥å¤±è´¥', 'æ— æ³•è¿æ¥åˆ°æœåŠ¡å™¨');
                };
                
                logWebSocket.onclose = () => {
                    if (realtimeLogEnabled) {
                        // å°è¯•é‡è¿
                        setTimeout(() => {
                            if (realtimeLogEnabled) {
                                connectRealtimeLogs();
                            }
                        }, 3000);
                    }
                };
            } catch (error) {
                console.error('Failed to connect realtime logs:', error);
                showNotification('error', 'å®æ—¶æ—¥å¿—è¿æ¥å¤±è´¥', error.message);
            }
        }

        // è¿½åŠ æ—¥å¿—æ¡ç›®
        function appendLogEntry(log) {
            const logsContainer = document.getElementById('logs-container');
            if (!logsContainer) return;
            
            const searchQuery = document.getElementById('log-search-input')?.value || '';
            let message = escapeHtml(log.message);
            if (searchQuery) {
                const regex = new RegExp(`(${escapeRegex(searchQuery)})`, 'gi');
                message = message.replace(regex, '<mark>$1</mark>');
            }
            
            const entry = document.createElement('div');
            entry.className = `log-entry ${log.type}`;
            entry.innerHTML = `[${formatTime(log.timestamp)}] ${message}`;
            
            logsContainer.appendChild(entry);
            
            // è‡ªåŠ¨æ»šåŠ¨åˆ°åº•éƒ¨
            if (realtimeLogEnabled) {
                logsContainer.scrollTop = logsContainer.scrollHeight;
            }
        }

        // å·¥å…·å‡½æ•°
        function escapeRegex(str) {
            return str.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
        }

        // å…³é—­ Pipeline è¯¦æƒ… Drawer
        function closePipelineDrawer() {
            document.getElementById('drawer-overlay').classList.remove('active');
            document.getElementById('pipeline-drawer').classList.remove('active');
            
            // å…³é—­å®æ—¶æ—¥å¿—è¿æ¥
            if (logWebSocket) {
                logWebSocket.close();
                logWebSocket = null;
            }
            realtimeLogEnabled = false;
            currentPipelineId = null;
            window.currentLogTypeFilter = '';
        }

        // å…³é—­æ‰€æœ‰ Drawer
        function closeAllDrawers() {
            document.getElementById('drawer-overlay').classList.remove('active');
            document.getElementById('pipeline-drawer').classList.remove('active');
            document.getElementById('run-pipeline-drawer').classList.remove('active');
            document.getElementById('settings-drawer').classList.remove('active');
        }

        // æ ‡ç­¾é¡µåˆ‡æ¢
        function switchTab(tabName) {
            // éšè—æ‰€æœ‰æ ‡ç­¾é¡µå†…å®¹
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            // ç§»é™¤æ‰€æœ‰æ ‡ç­¾çš„ active çŠ¶æ€
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });
            // æ˜¾ç¤ºé€‰ä¸­çš„æ ‡ç­¾é¡µ
            const tabContent = document.getElementById(`tab-${tabName}`);
            if (tabContent) {
                tabContent.classList.add('active');
            }
            // æ¿€æ´»å¯¹åº”çš„æ ‡ç­¾
            const tabs = document.querySelectorAll('.tab');
            tabs.forEach((tab, index) => {
                if ((tabName === 'logs' && index === 0) || (tabName === 'yaml' && index === 1)) {
                    tab.classList.add('active');
                }
            });
        }

        // æ˜¾ç¤ºè®¾ç½®é¢æ¿
        function showSettings() {
            closeAllDrawers();
            document.getElementById('drawer-overlay').classList.add('active');
            document.getElementById('settings-drawer').classList.add('active');
            
            // åŠ è½½å½“å‰è®¾ç½®
            loadSettings();
        }

        // å…³é—­è®¾ç½®é¢æ¿
        function closeSettingsDrawer() {
            closeAllDrawers();
        }

        // åŠ è½½è®¾ç½®
        async function loadSettings() {
            try {
                const response = await fetch(`${API_BASE}/settings`);
                const settings = await response.json();
                
                document.getElementById('setting-max-concurrent').value = settings.max_concurrent || 2;
                document.getElementById('setting-max-records').value = settings.max_records || 1000;
                document.getElementById('setting-refresh-interval').value = settings.refresh_interval || 5;
            } catch (error) {
                console.error('Failed to load settings:', error);
            }
        }

        // ä¿å­˜è®¾ç½®
        async function saveSettings() {
            const settings = {
                max_concurrent: parseInt(document.getElementById('setting-max-concurrent').value) || 2,
                max_records: parseInt(document.getElementById('setting-max-records').value) || 1000,
                refresh_interval: parseInt(document.getElementById('setting-refresh-interval').value) || 5,
            };

            try {
                const response = await fetch(`${API_BASE}/settings`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(settings),
                });

                if (response.ok) {
                    alert('è®¾ç½®å·²ä¿å­˜');
                    closeSettingsDrawer();
                    // æ›´æ–°åˆ·æ–°é—´éš”
                    if (window.refreshInterval) {
                        clearInterval(window.refreshInterval);
                    }
                    window.refreshInterval = setInterval(() => {
                        refreshPipelines();
                        refreshQueueStats();
                    }, settings.refresh_interval * 1000);
                } else {
                    alert('ä¿å­˜è®¾ç½®å¤±è´¥');
                }
            } catch (error) {
                console.error('Failed to save settings:', error);
                alert('ä¿å­˜è®¾ç½®å¤±è´¥: ' + error.message);
            }
        }

        // å·¥å…·å‡½æ•°
        function formatTime(timeStr) {
            if (!timeStr) return 'N/A';
            const date = new Date(timeStr);
            return date.toLocaleString('zh-CN');
        }

        function getDuration(pipeline) {
            const start = new Date(pipeline.started_at);
            const end = pipeline.succeed_at 
                ? new Date(pipeline.succeed_at)
                : pipeline.failed_at
                ? new Date(pipeline.failed_at)
                : new Date();
            
            const diff = Math.floor((end - start) / 1000);
            if (diff < 60) {
                return diff + 'ç§’';
            }
            if (diff < 3600) {
                const minutes = Math.floor(diff / 60);
                const seconds = diff % 60;
                return minutes + 'åˆ†' + seconds + 'ç§’';
            }
            const hours = Math.floor(diff / 3600);
            const minutes = Math.floor((diff % 3600) / 60);
            return hours + 'å°æ—¶' + minutes + 'åˆ†';
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // æ˜¾ç¤ºåˆ›å»º Pipeline Drawer
        function showRunPipeline() {
            // å…ˆå…³é—­å…¶ä»– drawer
            closePipelineDrawer();
            document.getElementById('drawer-overlay').classList.add('active');
            document.getElementById('run-pipeline-drawer').classList.add('active');
            
            // é»˜è®¤æ˜¾ç¤ºå¯è§†åŒ–ç¼–è¾‘å™¨
            switchEditorMode('visual');
            
            // åˆå§‹åŒ–é»˜è®¤é…ç½®
            const defaultYAML = `name: My Pipeline

stages:
  - name: build
    jobs:
      - name: build-job
        steps:
          - name: hello
            command: echo "Hello, Pipeline!"`;
            document.getElementById('pipeline-yaml').value = defaultYAML;
            
            // æ„å»ºå¯è§†åŒ–è¡¨å•
            buildVisualFormFromYAML(defaultYAML);
            
            document.getElementById('creation-status').style.display = 'none';
            document.getElementById('create-btn').disabled = false;
        }

        // æ¨¡å¼åˆ‡æ¢
        function switchEditorMode(mode) {
            const visualContainer = document.getElementById('visual-editor-container');
            const yamlContainer = document.getElementById('yaml-editor-container');
            const visualBtn = document.getElementById('mode-visual');
            const yamlBtn = document.getElementById('mode-yaml');
            const syncBtn = document.getElementById('sync-btn');

            if (mode === 'visual') {
                visualContainer.classList.add('active');
                yamlContainer.classList.remove('active');
                visualBtn.classList.add('active');
                yamlBtn.classList.remove('active');
                syncBtn.style.display = 'none';
                
                // å¦‚æœ YAML æœ‰å†…å®¹ï¼Œè½¬æ¢ä¸ºå¯è§†åŒ–
                const yaml = document.getElementById('pipeline-yaml').value.trim();
                if (yaml) {
                    buildVisualFormFromYAML(yaml);
                }
            } else {
                visualContainer.classList.remove('active');
                yamlContainer.classList.add('active');
                visualBtn.classList.remove('active');
                yamlBtn.classList.add('active');
                syncBtn.style.display = 'inline-block';
            }
        }

        // ä» YAML æ„å»ºå¯è§†åŒ–è¡¨å•
        async function buildVisualFormFromYAML(yaml) {
            if (!yaml.trim()) {
                buildEmptyVisualForm();
                return;
            }

            try {
                const response = await fetch(`${API_BASE}/configs/convert/yaml-to-visual`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ yaml: yaml }),
                });

                if (!response.ok) {
                    throw new Error('è½¬æ¢å¤±è´¥');
                }

                const data = await response.json();
                buildVisualForm(data.visual);
            } catch (error) {
                console.error('Failed to convert YAML to visual:', error);
                showNotification('error', 'è½¬æ¢å¤±è´¥', error.message);
            }
        }

        // æ„å»ºç©ºçš„å¯è§†åŒ–è¡¨å•
        function buildEmptyVisualForm() {
            const visual = {
                name: '',
                workdir: '',
                image: '',
                timeout: '',
                env: {},
                stages: []
            };
            buildVisualForm(visual);
        }

        // æ„å»ºå¯è§†åŒ–è¡¨å•
        function buildVisualForm(visual) {
            const container = document.getElementById('visual-editor');
            if (!visual) {
                visual = { name: '', stages: [] };
            }

            let html = `
                <div class="visual-section">
                    <div class="visual-section-title">Pipeline åŸºæœ¬ä¿¡æ¯</div>
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">åç§° <span class="required">*</span></label>
                            <input type="text" id="visual-name" class="form-input" value="${escapeHtml(visual.name || '')}" placeholder="Pipeline åç§°">
                        </div>
                        <div class="form-group">
                            <label class="form-label">å·¥ä½œç›®å½•</label>
                            <input type="text" id="visual-workdir" class="form-input" value="${escapeHtml(visual.workdir || '')}" placeholder="å·¥ä½œç›®å½•è·¯å¾„">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">é»˜è®¤é•œåƒ</label>
                            <input type="text" id="visual-image" class="form-input" value="${escapeHtml(visual.image || '')}" placeholder="docker é•œåƒ">
                        </div>
                        <div class="form-group">
                            <label class="form-label">è¶…æ—¶æ—¶é—´ï¼ˆç§’ï¼‰</label>
                            <input type="number" id="visual-timeout" class="form-input" value="${visual.timeout || ''}" placeholder="è¶…æ—¶æ—¶é—´">
                        </div>
                    </div>
                    <div class="form-row full">
                        <div class="form-group">
                            <label class="form-label">ç¯å¢ƒå˜é‡ï¼ˆæ¯è¡Œä¸€ä¸ªï¼Œæ ¼å¼ï¼šKEY=VALUEï¼‰</label>
                            <textarea id="visual-env" class="form-input env-vars-editor" placeholder="KEY1=VALUE1&#10;KEY2=VALUE2">${formatEnvVars(visual.environment || {})}</textarea>
                        </div>
                    </div>
                    <div class="form-row full">
                        <div class="form-group">
                            <label class="form-label">Pre Hookï¼ˆæ‰§è¡Œå‰çš„å‘½ä»¤ï¼‰</label>
                            <textarea id="visual-pre" class="form-input env-vars-editor" placeholder="echo 'Pre hook'">${escapeHtml(visual.pre || '')}</textarea>
                        </div>
                    </div>
                    <div class="form-row full">
                        <div class="form-group">
                            <label class="form-label">Post Hookï¼ˆæ‰§è¡Œåçš„å‘½ä»¤ï¼‰</label>
                            <textarea id="visual-post" class="form-input env-vars-editor" placeholder="echo 'Post hook'">${escapeHtml(visual.post || '')}</textarea>
                        </div>
                    </div>
                </div>

                <div class="visual-section">
                    <div class="visual-section-title">
                        Stages é…ç½®
                        <button class="btn-small btn-add" onclick="addStage()">â• æ·»åŠ  Stage</button>
                    </div>
                    <div id="stages-container">
            `;

            const stages = visual.stages || [];
            if (stages.length === 0) {
                html += '<div style="color: #6b7280; padding: 20px; text-align: center;">æš‚æ—  Stageï¼Œç‚¹å‡»ä¸Šæ–¹æŒ‰é’®æ·»åŠ </div>';
            } else {
                stages.forEach((stage, stageIdx) => {
                    html += buildStageForm(stage, stageIdx);
                });
            }

            html += `
                    </div>
                </div>
            `;

            container.innerHTML = html;
        }

        // æ„å»º Stage è¡¨å•
        function buildStageForm(stage, stageIdx) {
            if (!stage) stage = { name: '', mode: 'parallel', jobs: [] };
            
            let html = `
                <div class="stage-item" data-stage-index="${stageIdx}">
                    <div class="item-header">
                        <div class="item-title">Stage ${stageIdx + 1}</div>
                        <div class="item-actions">
                            <button class="btn-small btn-add" onclick="addJob(${stageIdx})">â• æ·»åŠ  Job</button>
                            <button class="btn-small btn-remove" onclick="removeStage(${stageIdx})">ğŸ—‘ï¸ åˆ é™¤</button>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">åç§° <span class="required">*</span></label>
                            <input type="text" class="form-input" data-stage-field="name" value="${escapeHtml(stage.name || '')}" placeholder="Stage åç§°">
                        </div>
                        <div class="form-group">
                            <label class="form-label">æ‰§è¡Œæ¨¡å¼</label>
                            <select class="form-input" data-stage-field="mode">
                                <option value="parallel" ${stage.mode === 'parallel' || stage.run_mode === 'parallel' ? 'selected' : ''}>å¹¶è¡Œ</option>
                                <option value="serial" ${stage.mode === 'serial' || stage.run_mode === 'serial' ? 'selected' : ''}>ä¸²è¡Œ</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">å·¥ä½œç›®å½•</label>
                            <input type="text" class="form-input" data-stage-field="workdir" value="${escapeHtml(stage.workdir || '')}" placeholder="å·¥ä½œç›®å½•è·¯å¾„">
                        </div>
                        <div class="form-group">
                            <label class="form-label">é•œåƒ</label>
                            <input type="text" class="form-input" data-stage-field="image" value="${escapeHtml(stage.image || '')}" placeholder="docker é•œåƒ">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">è¶…æ—¶æ—¶é—´ï¼ˆç§’ï¼‰</label>
                            <input type="number" class="form-input" data-stage-field="timeout" value="${stage.timeout || ''}" placeholder="è¶…æ—¶æ—¶é—´">
                        </div>
                    </div>
                    <div class="form-row full">
                        <div class="form-group">
                            <label class="form-label">ç¯å¢ƒå˜é‡ï¼ˆæ¯è¡Œä¸€ä¸ªï¼Œæ ¼å¼ï¼šKEY=VALUEï¼‰</label>
                            <textarea class="form-input env-vars-editor" data-stage-field="env" placeholder="KEY1=VALUE1&#10;KEY2=VALUE2">${formatEnvVars(stage.environment || {})}</textarea>
                        </div>
                    </div>
                    <div id="jobs-container-${stageIdx}">
            `;

            const jobs = stage.jobs || [];
            if (jobs.length === 0) {
                html += '<div style="color: #6b7280; padding: 10px; text-align: center; font-size: 13px;">æš‚æ—  Jobï¼Œç‚¹å‡»ä¸Šæ–¹æŒ‰é’®æ·»åŠ </div>';
            } else {
                jobs.forEach((job, jobIdx) => {
                    html += buildJobForm(stageIdx, job, jobIdx);
                });
            }

            html += `
                    </div>
                </div>
            `;

            return html;
        }

        // æ„å»º Job è¡¨å•
        function buildJobForm(stageIdx, job, jobIdx) {
            if (!job) job = { name: '', image: '', steps: [] };
            
            let html = `
                <div class="job-item" data-stage-index="${stageIdx}" data-job-index="${jobIdx}">
                    <div class="item-header">
                        <div class="item-title">Job ${jobIdx + 1}</div>
                        <div class="item-actions">
                            <button class="btn-small btn-add" onclick="addStep(${stageIdx}, ${jobIdx})">â• æ·»åŠ  Step</button>
                            <button class="btn-small btn-remove" onclick="removeJob(${stageIdx}, ${jobIdx})">ğŸ—‘ï¸ åˆ é™¤</button>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">åç§° <span class="required">*</span></label>
                            <input type="text" class="form-input" data-job-field="name" value="${escapeHtml(job.name || '')}" placeholder="Job åç§°">
                        </div>
                        <div class="form-group">
                            <label class="form-label">é•œåƒ</label>
                            <input type="text" class="form-input" data-job-field="image" value="${escapeHtml(job.image || '')}" placeholder="docker é•œåƒ">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">å·¥ä½œç›®å½•</label>
                            <input type="text" class="form-input" data-job-field="workdir" value="${escapeHtml(job.workdir || '')}" placeholder="å·¥ä½œç›®å½•è·¯å¾„">
                        </div>
                        <div class="form-group">
                            <label class="form-label">è¶…æ—¶æ—¶é—´ï¼ˆç§’ï¼‰</label>
                            <input type="number" class="form-input" data-job-field="timeout" value="${job.timeout || ''}" placeholder="è¶…æ—¶æ—¶é—´">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">é•œåƒä»“åº“</label>
                            <input type="text" class="form-input" data-job-field="image_registry" value="${escapeHtml(job.image_registry || '')}" placeholder="docker.io">
                        </div>
                        <div class="form-group">
                            <label class="form-label">é•œåƒä»“åº“ç”¨æˆ·å</label>
                            <input type="text" class="form-input" data-job-field="image_registry_username" value="${escapeHtml(job.image_registry_username || '')}" placeholder="ç”¨æˆ·å">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">é•œåƒä»“åº“å¯†ç </label>
                            <input type="password" class="form-input" data-job-field="image_registry_password" value="${escapeHtml(job.image_registry_password || '')}" placeholder="å¯†ç ">
                        </div>
                    </div>
                    <div class="form-row full">
                        <div class="form-group">
                            <label class="form-label">ç¯å¢ƒå˜é‡ï¼ˆæ¯è¡Œä¸€ä¸ªï¼Œæ ¼å¼ï¼šKEY=VALUEï¼‰</label>
                            <textarea class="form-input env-vars-editor" data-job-field="env" placeholder="KEY1=VALUE1&#10;KEY2=VALUE2">${formatEnvVars(job.environment || {})}</textarea>
                        </div>
                    </div>
                    <div id="steps-container-${stageIdx}-${jobIdx}">
            `;

            const steps = job.steps || [];
            if (steps.length === 0) {
                html += '<div style="color: #6b7280; padding: 10px; text-align: center; font-size: 13px;">æš‚æ—  Stepï¼Œç‚¹å‡»ä¸Šæ–¹æŒ‰é’®æ·»åŠ </div>';
            } else {
                steps.forEach((step, stepIdx) => {
                    html += buildStepForm(stageIdx, jobIdx, step, stepIdx);
                });
            }

            html += `
                    </div>
                </div>
            `;

            return html;
        }

        // æ„å»º Step è¡¨å•
        function buildStepForm(stageIdx, jobIdx, step, stepIdx) {
            if (!step) step = { name: '', command: '' };
            
            return `
                <div class="step-item" data-stage-index="${stageIdx}" data-job-index="${jobIdx}" data-step-index="${stepIdx}">
                    <div class="item-header">
                        <div class="item-title">Step ${stepIdx + 1}</div>
                        <div class="item-actions">
                            <button class="btn-small btn-remove" onclick="removeStep(${stageIdx}, ${jobIdx}, ${stepIdx})">ğŸ—‘ï¸ åˆ é™¤</button>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">åç§° <span class="required">*</span></label>
                            <input type="text" class="form-input" data-step-field="name" value="${escapeHtml(step.name || '')}" placeholder="Step åç§°">
                        </div>
                    </div>
                    <div class="form-row full">
                        <div class="form-group">
                            <label class="form-label">å‘½ä»¤ <span class="required">*</span></label>
                            <textarea class="form-input env-vars-editor" data-step-field="command" placeholder="æ‰§è¡Œçš„å‘½ä»¤ï¼ˆæ”¯æŒå¤šè¡Œè„šæœ¬ï¼‰">${escapeHtml(step.command || '')}</textarea>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">æ‰§è¡Œå¼•æ“</label>
                            <select class="form-input" data-step-field="engine">
                                <option value="">é»˜è®¤</option>
                                <option value="docker" ${step.engine === 'docker' ? 'selected' : ''}>Docker</option>
                                <option value="local" ${step.engine === 'local' ? 'selected' : ''}>Local</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">é•œåƒ</label>
                            <input type="text" class="form-input" data-step-field="image" value="${escapeHtml(step.image || '')}" placeholder="docker é•œåƒ">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Shell</label>
                            <input type="text" class="form-input" data-step-field="shell" value="${escapeHtml(step.shell || '')}" placeholder="shell è·¯å¾„">
                        </div>
                        <div class="form-group">
                            <label class="form-label">å·¥ä½œç›®å½•</label>
                            <input type="text" class="form-input" data-step-field="workdir" value="${escapeHtml(step.workdir || '')}" placeholder="å·¥ä½œç›®å½•">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">è¶…æ—¶æ—¶é—´ï¼ˆç§’ï¼‰</label>
                            <input type="number" class="form-input" data-step-field="timeout" value="${step.timeout || ''}" placeholder="è¶…æ—¶æ—¶é—´">
                        </div>
                        <div class="form-group">
                            <label class="form-label">é•œåƒä»“åº“</label>
                            <input type="text" class="form-input" data-step-field="image_registry" value="${escapeHtml(step.image_registry || '')}" placeholder="docker.io">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">é•œåƒä»“åº“ç”¨æˆ·å</label>
                            <input type="text" class="form-input" data-step-field="image_registry_username" value="${escapeHtml(step.image_registry_username || '')}" placeholder="ç”¨æˆ·å">
                        </div>
                        <div class="form-group">
                            <label class="form-label">é•œåƒä»“åº“å¯†ç </label>
                            <input type="password" class="form-input" data-step-field="image_registry_password" value="${escapeHtml(step.image_registry_password || '')}" placeholder="å¯†ç ">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">æ•°æ®ç›®å½•ï¼ˆå†…éƒ¨ï¼‰</label>
                            <input type="text" class="form-input" data-step-field="data_dir_inner" value="${escapeHtml(step.data_dir_inner || '')}" placeholder="å®¹å™¨å†…æ•°æ®ç›®å½•">
                        </div>
                        <div class="form-group">
                            <label class="form-label">æ•°æ®ç›®å½•ï¼ˆå¤–éƒ¨ï¼‰</label>
                            <input type="text" class="form-input" data-step-field="data_dir_outer" value="${escapeHtml(step.data_dir_outer || '')}" placeholder="å®¿ä¸»æœºæ•°æ®ç›®å½•">
                        </div>
                    </div>
                    <div class="form-row full">
                        <div class="form-group">
                            <label class="form-label">ç¯å¢ƒå˜é‡ï¼ˆæ¯è¡Œä¸€ä¸ªï¼Œæ ¼å¼ï¼šKEY=VALUEï¼‰</label>
                            <textarea class="form-input env-vars-editor" data-step-field="env" placeholder="KEY1=VALUE1&#10;KEY2=VALUE2">${formatEnvVars(step.environment || {})}</textarea>
                        </div>
                    </div>
                    <div class="form-row full" style="margin-top: 15px; padding-top: 15px; border-top: 1px solid #e5e7eb;">
                        <div class="form-group">
                            <label class="form-label" style="font-weight: 600; margin-bottom: 10px;">é«˜çº§é…ç½®ï¼ˆå¯é€‰ï¼‰</label>
                            <div style="margin-bottom: 15px; padding: 10px; background: #f9fafb; border-radius: 4px;">
                                <div style="font-weight: 600; margin-bottom: 8px;">Plugin é…ç½®</div>
                                <div class="form-row">
                                    <div class="form-group">
                                        <label class="form-label">Plugin é•œåƒ</label>
                                        <input type="text" class="form-input" data-step-field="plugin_image" value="${escapeHtml((step.plugin && step.plugin.image) || '')}" placeholder="plugin é•œåƒ">
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label">Entrypoint</label>
                                        <input type="text" class="form-input" data-step-field="plugin_entrypoint" value="${escapeHtml((step.plugin && step.plugin.entrypoint) || '')}" placeholder="/pipeline/plugin/run">
                                    </div>
                                </div>
                                <div class="form-row full">
                                    <div class="form-group">
                                        <label class="form-label">Plugin è®¾ç½®ï¼ˆæ¯è¡Œä¸€ä¸ªï¼Œæ ¼å¼ï¼šKEY=VALUEï¼‰</label>
                                        <textarea class="form-input env-vars-editor" data-step-field="plugin_settings" placeholder="KEY1=VALUE1&#10;KEY2=VALUE2">${formatEnvVars((step.plugin && step.plugin.settings) || {})}</textarea>
                                    </div>
                                </div>
                            </div>
                            <div style="margin-bottom: 15px; padding: 10px; background: #f9fafb; border-radius: 4px;">
                                <div style="font-weight: 600; margin-bottom: 8px;">Language é…ç½®</div>
                                <div class="form-row">
                                    <div class="form-group">
                                        <label class="form-label">è¯­è¨€åç§°</label>
                                        <input type="text" class="form-input" data-step-field="language_name" value="${escapeHtml((step.language && step.language.name) || '')}" placeholder="node, go, python">
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label">è¯­è¨€ç‰ˆæœ¬</label>
                                        <input type="text" class="form-input" data-step-field="language_version" value="${escapeHtml((step.language && step.language.version) || '')}" placeholder="12, 1.20, 3.10">
                                    </div>
                                </div>
                            </div>
                            <div style="margin-bottom: 15px; padding: 10px; background: #f9fafb; border-radius: 4px;">
                                <div style="font-weight: 600; margin-bottom: 8px;">Service é…ç½®</div>
                                <div class="form-row">
                                    <div class="form-group">
                                        <label class="form-label">Service ç±»å‹</label>
                                        <select class="form-input" data-step-field="service_type">
                                            <option value="">è¯·é€‰æ‹©</option>
                                            <option value="docker-compose" ${(step.service && step.service.type === 'docker-compose') ? 'selected' : ''}>Docker Compose</option>
                                            <option value="docker-swarm" ${(step.service && step.service.type === 'docker-swarm') ? 'selected' : ''}>Docker Swarm</option>
                                            <option value="kubernetes" ${(step.service && step.service.type === 'kubernetes') ? 'selected' : ''}>Kubernetes</option>
                                        </select>
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label">Service åç§°</label>
                                        <input type="text" class="form-input" data-step-field="service_name" value="${escapeHtml((step.service && step.service.name) || '')}" placeholder="æœåŠ¡åç§°">
                                    </div>
                                </div>
                                <div class="form-row">
                                    <div class="form-group">
                                        <label class="form-label">Service ç‰ˆæœ¬</label>
                                        <input type="text" class="form-input" data-step-field="service_version" value="${escapeHtml((step.service && step.service.version) || '')}" placeholder="v1">
                                    </div>
                                </div>
                                <div class="form-row full">
                                    <div class="form-group">
                                        <label class="form-label">Service é…ç½®ï¼ˆYAMLï¼‰</label>
                                        <textarea class="form-input env-vars-editor" data-step-field="service_config" placeholder="Service é…ç½®å†…å®¹">${escapeHtml((step.service && step.service.config) || '')}</textarea>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        // ä»å¯è§†åŒ–è¡¨å•æ”¶é›†æ•°æ®
        function getVisualConfig() {
            const config = {
                name: document.getElementById('visual-name').value.trim(),
                workdir: document.getElementById('visual-workdir').value.trim() || undefined,
                image: document.getElementById('visual-image').value.trim() || undefined,
                timeout: document.getElementById('visual-timeout').value.trim() || undefined,
                environment: parseEnvVars(document.getElementById('visual-env').value),
                pre: document.getElementById('visual-pre').value.trim() || undefined,
                post: document.getElementById('visual-post').value.trim() || undefined,
                stages: []
            };

            // æ”¶é›† Stages
            const stageItems = document.querySelectorAll('.stage-item');
            stageItems.forEach((stageItem, stageIdx) => {
                const stage = {
                    name: stageItem.querySelector('[data-stage-field="name"]').value.trim(),
                    run_mode: stageItem.querySelector('[data-stage-field="mode"]').value || 'parallel',
                    jobs: []
                };

                // æ”¶é›† Stage å…¶ä»–å­—æ®µ
                const workdir = stageItem.querySelector('[data-stage-field="workdir"]').value.trim();
                if (workdir) stage.workdir = workdir;

                const image = stageItem.querySelector('[data-stage-field="image"]').value.trim();
                if (image) stage.image = image;

                const timeout = stageItem.querySelector('[data-stage-field="timeout"]').value.trim();
                if (timeout) stage.timeout = parseInt(timeout) || undefined;

                // æ”¶é›† Stage ç¯å¢ƒå˜é‡
                const stageEnvTextarea = stageItem.querySelector('[data-stage-field="env"]');
                if (stageEnvTextarea) {
                    const env = parseEnvVars(stageEnvTextarea.value);
                    if (Object.keys(env).length > 0) {
                        stage.environment = env;
                    }
                }

                // æ”¶é›† Jobs
                const jobItems = stageItem.querySelectorAll(`.job-item[data-stage-index="${stageIdx}"]`);
                jobItems.forEach((jobItem, jobIdx) => {
                    const job = {
                        name: jobItem.querySelector('[data-job-field="name"]').value.trim(),
                        image: jobItem.querySelector('[data-job-field="image"]').value.trim() || undefined,
                        steps: []
                    };

                    // æ”¶é›† Job å…¶ä»–å­—æ®µ
                    const workdir = jobItem.querySelector('[data-job-field="workdir"]').value.trim();
                    if (workdir) job.workdir = workdir;

                    const timeout = jobItem.querySelector('[data-job-field="timeout"]').value.trim();
                    if (timeout) job.timeout = parseInt(timeout) || undefined;

                    const imageRegistry = jobItem.querySelector('[data-job-field="image_registry"]').value.trim();
                    if (imageRegistry) job.image_registry = imageRegistry;

                    const imageRegistryUsername = jobItem.querySelector('[data-job-field="image_registry_username"]').value.trim();
                    if (imageRegistryUsername) job.image_registry_username = imageRegistryUsername;

                    const imageRegistryPassword = jobItem.querySelector('[data-job-field="image_registry_password"]').value.trim();
                    if (imageRegistryPassword) job.image_registry_password = imageRegistryPassword;

                    // æ”¶é›† Job ç¯å¢ƒå˜é‡
                    const jobEnvTextarea = jobItem.querySelector('[data-job-field="env"]');
                    if (jobEnvTextarea) {
                        const env = parseEnvVars(jobEnvTextarea.value);
                        if (Object.keys(env).length > 0) {
                            job.environment = env;
                        }
                    }

                    // æ”¶é›† Steps
                    const stepItems = jobItem.querySelectorAll(`.step-item[data-stage-index="${stageIdx}"][data-job-index="${jobIdx}"]`);
                    stepItems.forEach((stepItem) => {
                        const step = {
                            name: stepItem.querySelector('[data-step-field="name"]').value.trim(),
                            command: stepItem.querySelector('[data-step-field="command"]').value.trim(),
                        };

                        const engine = stepItem.querySelector('[data-step-field="engine"]').value.trim();
                        if (engine) step.engine = engine;

                        const image = stepItem.querySelector('[data-step-field="image"]').value.trim();
                        if (image) step.image = image;

                        const shell = stepItem.querySelector('[data-step-field="shell"]').value.trim();
                        if (shell) step.shell = shell;

                        const workdir = stepItem.querySelector('[data-step-field="workdir"]').value.trim();
                        if (workdir) step.workdir = workdir;

                        const timeout = stepItem.querySelector('[data-step-field="timeout"]').value.trim();
                        if (timeout) step.timeout = parseInt(timeout) || undefined;

                        const imageRegistry = stepItem.querySelector('[data-step-field="image_registry"]').value.trim();
                        if (imageRegistry) step.image_registry = imageRegistry;

                        const imageRegistryUsername = stepItem.querySelector('[data-step-field="image_registry_username"]').value.trim();
                        if (imageRegistryUsername) step.image_registry_username = imageRegistryUsername;

                        const imageRegistryPassword = stepItem.querySelector('[data-step-field="image_registry_password"]').value.trim();
                        if (imageRegistryPassword) step.image_registry_password = imageRegistryPassword;

                        const dataDirInner = stepItem.querySelector('[data-step-field="data_dir_inner"]').value.trim();
                        if (dataDirInner) step.data_dir_inner = dataDirInner;

                        const dataDirOuter = stepItem.querySelector('[data-step-field="data_dir_outer"]').value.trim();
                        if (dataDirOuter) step.data_dir_outer = dataDirOuter;

                        // æ”¶é›† Step ç¯å¢ƒå˜é‡
                        const stepEnvTextarea = stepItem.querySelector('[data-step-field="env"]');
                        if (stepEnvTextarea) {
                            const env = parseEnvVars(stepEnvTextarea.value);
                            if (Object.keys(env).length > 0) {
                                step.environment = env;
                            }
                        }

                        // æ”¶é›† Plugin é…ç½®
                        const pluginImage = stepItem.querySelector('[data-step-field="plugin_image"]');
                        const pluginEntrypoint = stepItem.querySelector('[data-step-field="plugin_entrypoint"]');
                        const pluginSettings = stepItem.querySelector('[data-step-field="plugin_settings"]');
                        if (pluginImage && pluginImage.value.trim()) {
                            step.plugin = {
                                image: pluginImage.value.trim(),
                                entrypoint: pluginEntrypoint ? pluginEntrypoint.value.trim() || '/pipeline/plugin/run' : '/pipeline/plugin/run',
                                settings: pluginSettings ? parseEnvVars(pluginSettings.value) : {}
                            };
                        }

                        // æ”¶é›† Language é…ç½®
                        const languageName = stepItem.querySelector('[data-step-field="language_name"]');
                        const languageVersion = stepItem.querySelector('[data-step-field="language_version"]');
                        if (languageName && languageName.value.trim()) {
                            step.language = {
                                name: languageName.value.trim(),
                                version: languageVersion ? languageVersion.value.trim() : ''
                            };
                        }

                        // æ”¶é›† Service é…ç½®
                        const serviceType = stepItem.querySelector('[data-step-field="service_type"]');
                        const serviceName = stepItem.querySelector('[data-step-field="service_name"]');
                        const serviceVersion = stepItem.querySelector('[data-step-field="service_version"]');
                        const serviceConfig = stepItem.querySelector('[data-step-field="service_config"]');
                        if (serviceType && serviceType.value.trim()) {
                            step.service = {
                                type: serviceType.value.trim(),
                                name: serviceName ? serviceName.value.trim() : '',
                                version: serviceVersion ? serviceVersion.value.trim() : '',
                                config: serviceConfig ? serviceConfig.value.trim() : ''
                            };
                        }

                        job.steps.push(step);
                    });

                    stage.jobs.push(job);
                });

                config.stages.push(stage);
            });

            // æ¸…ç†ç©ºå€¼
            Object.keys(config).forEach(key => {
                if (config[key] === undefined || (Array.isArray(config[key]) && config[key].length === 0)) {
                    delete config[key];
                }
            });

            // æ¸…ç†ç©ºçš„ç¯å¢ƒå˜é‡å¯¹è±¡
            if (config.environment && Object.keys(config.environment).length === 0) {
                delete config.environment;
            }

            // é€’å½’æ¸…ç† stages ä¸­çš„ç©ºç¯å¢ƒå˜é‡
            config.stages.forEach(stage => {
                if (stage.environment && Object.keys(stage.environment).length === 0) {
                    delete stage.environment;
                }
                stage.jobs.forEach(job => {
                    if (job.environment && Object.keys(job.environment).length === 0) {
                        delete job.environment;
                    }
                    job.steps.forEach(step => {
                        if (step.environment && Object.keys(step.environment).length === 0) {
                            delete step.environment;
                        }
                    });
                });
            });

            return config;
        }

        // è§£æç¯å¢ƒå˜é‡
        function parseEnvVars(text) {
            const env = {};
            if (!text) return env;
            
            text.split('\n').forEach(line => {
                line = line.trim();
                if (!line || line.startsWith('#')) return;
                
                const idx = line.indexOf('=');
                if (idx > 0) {
                    const key = line.substring(0, idx).trim();
                    const value = line.substring(idx + 1).trim();
                    if (key) {
                        env[key] = value;
                    }
                }
            });
            
            return env;
        }

        // æ ¼å¼åŒ–ç¯å¢ƒå˜é‡
        function formatEnvVars(env) {
            if (!env || Object.keys(env).length === 0) return '';
            return Object.entries(env).map(([k, v]) => `${k}=${v}`).join('\n');
        }

        // åŒæ­¥å¯è§†åŒ–é…ç½®åˆ° YAML
        async function syncVisualToYAML() {
            const visual = getVisualConfig();
            
            // éªŒè¯å¿…å¡«é¡¹
            if (!visual.name) {
                showNotification('error', 'éªŒè¯å¤±è´¥', 'Pipeline åç§°ä¸èƒ½ä¸ºç©º');
                return;
            }

            if (!visual.stages || visual.stages.length === 0) {
                showNotification('error', 'éªŒè¯å¤±è´¥', 'è‡³å°‘éœ€è¦æ·»åŠ ä¸€ä¸ª Stage');
                return;
            }

            for (const stage of visual.stages) {
                if (!stage.name) {
                    showNotification('error', 'éªŒè¯å¤±è´¥', 'Stage åç§°ä¸èƒ½ä¸ºç©º');
                    return;
                }
                if (!stage.jobs || stage.jobs.length === 0) {
                    showNotification('error', 'éªŒè¯å¤±è´¥', 'æ¯ä¸ª Stage è‡³å°‘éœ€è¦æ·»åŠ ä¸€ä¸ª Job');
                    return;
                }
                for (const job of stage.jobs) {
                    if (!job.name) {
                        showNotification('error', 'éªŒè¯å¤±è´¥', 'Job åç§°ä¸èƒ½ä¸ºç©º');
                        return;
                    }
                    if (!job.steps || job.steps.length === 0) {
                        showNotification('error', 'éªŒè¯å¤±è´¥', 'æ¯ä¸ª Job è‡³å°‘éœ€è¦æ·»åŠ ä¸€ä¸ª Step');
                        return;
                    }
                    for (const step of job.steps) {
                        if (!step.name || !step.command) {
                            showNotification('error', 'éªŒè¯å¤±è´¥', 'Step åç§°å’Œå‘½ä»¤ä¸èƒ½ä¸ºç©º');
                            return;
                        }
                    }
                }
            }

            try {
                const response = await fetch(`${API_BASE}/configs/convert/visual-to-yaml`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ visual: visual }),
                });

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.error || 'è½¬æ¢å¤±è´¥');
                }

                const data = await response.json();
                document.getElementById('pipeline-yaml').value = data.yaml;
                showNotification('success', 'åŒæ­¥æˆåŠŸ', 'å¯è§†åŒ–é…ç½®å·²åŒæ­¥åˆ° YAML');
            } catch (error) {
                console.error('Failed to convert visual to YAML:', error);
                showNotification('error', 'è½¬æ¢å¤±è´¥', error.message);
            }
        }

        // åŒæ­¥ YAML åˆ°å¯è§†åŒ–é…ç½®ï¼ˆè‡ªåŠ¨ï¼‰
        async function syncYAMLToVisual() {
            // åªåœ¨å¯è§†åŒ–æ¨¡å¼ä¸‹è‡ªåŠ¨åŒæ­¥
            const visualContainer = document.getElementById('visual-editor-container');
            if (!visualContainer.classList.contains('active')) {
                return;
            }

            const yaml = document.getElementById('pipeline-yaml').value.trim();
            if (!yaml) {
                buildEmptyVisualForm();
                return;
            }

            // é˜²æŠ–å¤„ç†
            if (window.syncYAMLTimeout) {
                clearTimeout(window.syncYAMLTimeout);
            }
            window.syncYAMLTimeout = setTimeout(() => {
                buildVisualFormFromYAML(yaml);
            }, 500);
        }

        // æ·»åŠ  Stage
        function addStage() {
            const container = document.getElementById('stages-container');
            const stageIdx = container.querySelectorAll('.stage-item').length;
            const newStage = { name: '', mode: 'parallel', jobs: [] };
            const html = buildStageForm(newStage, stageIdx);
            container.insertAdjacentHTML('beforeend', html);
        }

        // åˆ é™¤ Stage
        function removeStage(stageIdx) {
            const stageItem = document.querySelector(`.stage-item[data-stage-index="${stageIdx}"]`);
            if (stageItem && confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ª Stage å—ï¼Ÿ')) {
                stageItem.remove();
                // é‡æ–°ç¼–å·
                reindexStages();
            }
        }

        // æ·»åŠ  Job
        function addJob(stageIdx) {
            const container = document.getElementById(`jobs-container-${stageIdx}`);
            const jobIdx = container.querySelectorAll('.job-item').length;
            const newJob = { name: '', image: '', steps: [] };
            const html = buildJobForm(stageIdx, newJob, jobIdx);
            container.insertAdjacentHTML('beforeend', html);
        }

        // åˆ é™¤ Job
        function removeJob(stageIdx, jobIdx) {
            const jobItem = document.querySelector(`.job-item[data-stage-index="${stageIdx}"][data-job-index="${jobIdx}"]`);
            if (jobItem && confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ª Job å—ï¼Ÿ')) {
                jobItem.remove();
                reindexJobs(stageIdx);
            }
        }

        // æ·»åŠ  Step
        function addStep(stageIdx, jobIdx) {
            const container = document.getElementById(`steps-container-${stageIdx}-${jobIdx}`);
            const stepIdx = container.querySelectorAll('.step-item').length;
            const newStep = { name: '', command: '' };
            const html = buildStepForm(stageIdx, jobIdx, newStep, stepIdx);
            container.insertAdjacentHTML('beforeend', html);
        }

        // åˆ é™¤ Step
        function removeStep(stageIdx, jobIdx, stepIdx) {
            const stepItem = document.querySelector(`.step-item[data-stage-index="${stageIdx}"][data-job-index="${jobIdx}"][data-step-index="${stepIdx}"]`);
            if (stepItem && confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ª Step å—ï¼Ÿ')) {
                stepItem.remove();
                reindexSteps(stageIdx, jobIdx);
            }
        }

        // é‡æ–°ç¼–å· Stages
        function reindexStages() {
            const stageItems = document.querySelectorAll('.stage-item');
            stageItems.forEach((item, idx) => {
                item.setAttribute('data-stage-index', idx);
                item.querySelector('.item-title').textContent = `Stage ${idx + 1}`;
                // æ›´æ–°æŒ‰é’®çš„ onclick
                const addJobBtn = item.querySelector('.btn-add');
                if (addJobBtn) {
                    addJobBtn.setAttribute('onclick', `addJob(${idx})`);
                }
                const removeBtn = item.querySelector('.btn-remove');
                if (removeBtn) {
                    removeBtn.setAttribute('onclick', `removeStage(${idx})`);
                }
                // é‡æ–°ç¼–å· Jobs
                reindexJobs(idx);
            });
        }

        // é‡æ–°ç¼–å· Jobs
        function reindexJobs(stageIdx) {
            const jobItems = document.querySelectorAll(`.job-item[data-stage-index="${stageIdx}"]`);
            jobItems.forEach((item, idx) => {
                item.setAttribute('data-job-index', idx);
                item.querySelector('.item-title').textContent = `Job ${idx + 1}`;
                // æ›´æ–°æŒ‰é’®çš„ onclick
                const addStepBtn = item.querySelector('.btn-add');
                if (addStepBtn) {
                    addStepBtn.setAttribute('onclick', `addStep(${stageIdx}, ${idx})`);
                }
                const removeBtn = item.querySelector('.btn-remove');
                if (removeBtn) {
                    removeBtn.setAttribute('onclick', `removeJob(${stageIdx}, ${idx})`);
                }
                // é‡æ–°ç¼–å· Steps
                reindexSteps(stageIdx, idx);
            });
        }

        // é‡æ–°ç¼–å· Steps
        function reindexSteps(stageIdx, jobIdx) {
            const stepItems = document.querySelectorAll(`.step-item[data-stage-index="${stageIdx}"][data-job-index="${jobIdx}"]`);
            stepItems.forEach((item, idx) => {
                item.setAttribute('data-step-index', idx);
                item.querySelector('.item-title').textContent = `Step ${idx + 1}`;
                // æ›´æ–°æŒ‰é’®çš„ onclick
                const removeBtn = item.querySelector('.btn-remove');
                if (removeBtn) {
                    removeBtn.setAttribute('onclick', `removeStep(${stageIdx}, ${jobIdx}, ${idx})`);
                }
            });
        }

        // å…³é—­åˆ›å»º Drawer
        function closeRunDrawer() {
            closeAllDrawers();
        }

        // åˆ›å»º Pipelineï¼ˆåŠ å…¥é˜Ÿåˆ—ï¼‰
        async function createPipeline() {
            let yaml = '';
            
            // æ£€æŸ¥å½“å‰æ¨¡å¼
            const visualContainer = document.getElementById('visual-editor-container');
            if (visualContainer.classList.contains('active')) {
                // å¯è§†åŒ–æ¨¡å¼ï¼šå…ˆè½¬æ¢ä¸º YAML
                await syncVisualToYAML();
                yaml = document.getElementById('pipeline-yaml').value.trim();
            } else {
                // YAML æ¨¡å¼ï¼šç›´æ¥è·å–
                yaml = document.getElementById('pipeline-yaml').value.trim();
            }
            
            if (!yaml) {
                showNotification('error', 'åˆ›å»ºå¤±è´¥', 'è¯·è¾“å…¥ Pipeline é…ç½®');
                return;
            }

            const createBtn = document.getElementById('create-btn');
            const statusDiv = document.getElementById('creation-status');

            createBtn.disabled = true;
            statusDiv.style.display = 'block';
            statusDiv.className = 'execution-status running';
            statusDiv.textContent = 'æ­£åœ¨åˆ›å»º Pipeline...';

            try {
                // è·å– WebSocket è·¯å¾„
                const wsProtocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
                const wsPath = window.location.pathname.replace('/console', '') || '/';
                const wsURL = `${wsProtocol}//${window.location.host}${wsPath}`;

                // åˆ›å»º WebSocket è¿æ¥
                const ws = new WebSocket(wsURL);

                ws.onopen = () => {
                    statusDiv.textContent = 'æ­£åœ¨æ·»åŠ åˆ°é˜Ÿåˆ—...';

                    // å‘é€ pipeline é…ç½®
                    const action = {
                        type: 'run',
                        payload: yaml
                    };
                    ws.send(JSON.stringify(action));
                };

                ws.onmessage = (event) => {
                    try {
                        const msg = JSON.parse(event.data);
                        if (msg.type === 'done') {
                            // æ˜¾ç¤ºæˆåŠŸé€šçŸ¥
                            showNotification('success', 'Pipeline åˆ›å»ºæˆåŠŸ', 'Pipeline å·²æˆåŠŸæ·»åŠ åˆ°æ‰§è¡Œé˜Ÿåˆ—');
                            // ç«‹å³å…³é—­ Drawer å¹¶åˆ·æ–°
                            refreshPipelines();
                            refreshQueueStats();
                            closeRunDrawer();
                        } else if (msg.type === 'error') {
                            showNotification('error', 'åˆ›å»ºå¤±è´¥', msg.payload || 'æœªçŸ¥é”™è¯¯');
                            statusDiv.className = 'execution-status failed';
                            statusDiv.textContent = `âŒ åˆ›å»ºå¤±è´¥: ${msg.payload || 'æœªçŸ¥é”™è¯¯'}`;
                            createBtn.disabled = false;
                        }
                    } catch (error) {
                        // å¿½ç•¥è§£æé”™è¯¯
                    }
                };

                ws.onerror = (error) => {
                    statusDiv.className = 'execution-status failed';
                    statusDiv.textContent = `âŒ è¿æ¥é”™è¯¯: ${error}`;
                    createBtn.disabled = false;
                };

                ws.onclose = () => {
                    if (statusDiv.textContent.includes('æ­£åœ¨')) {
                        statusDiv.className = 'execution-status failed';
                        statusDiv.textContent = 'âŒ è¿æ¥å·²å…³é—­';
                        createBtn.disabled = false;
                    }
                };

            } catch (error) {
                showNotification('error', 'åˆ›å»ºå¤±è´¥', error.message);
                statusDiv.className = 'execution-status failed';
                statusDiv.textContent = `âŒ åˆ›å»ºå¤±è´¥: ${error.message}`;
                createBtn.disabled = false;
            }
        }

        // æ˜¾ç¤ºé€šçŸ¥
        function showNotification(type, title, message) {
            const container = document.getElementById('notification-container');
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            
            const icons = {
                success: 'âœ…',
                error: 'âŒ',
                warning: 'âš ï¸',
                info: 'â„¹ï¸'
            };

            notification.innerHTML = `
                <div class="notification-icon">${icons[type] || 'â„¹ï¸'}</div>
                <div class="notification-content">
                    <div class="notification-title">${escapeHtml(title)}</div>
                    <div class="notification-message">${escapeHtml(message)}</div>
                </div>
                <button class="notification-close" onclick="closeNotification(this)">&times;</button>
            `;

            container.appendChild(notification);

            // 3ç§’åè‡ªåŠ¨å…³é—­
            setTimeout(() => {
                closeNotification(notification.querySelector('.notification-close'));
            }, 3000);
        }

        // å…³é—­é€šçŸ¥
        function closeNotification(btn) {
            const notification = btn.closest('.notification');
            if (notification) {
                notification.classList.add('hiding');
                setTimeout(() => {
                    notification.remove();
                }, 300);
            }
        }

        // å–æ¶ˆ Pipeline
        async function cancelPipeline(id) {
            if (!confirm('ç¡®å®šè¦å–æ¶ˆè¿™ä¸ª Pipeline å—ï¼Ÿ')) {
                return;
            }

            try {
                const response = await fetch(`${API_BASE}/pipelines/${id}/cancel`, {
                    method: 'POST',
                });

                if (response.ok) {
                    const result = await response.json();
                    showNotification('success', 'å–æ¶ˆæˆåŠŸ', 'Pipeline å·²æˆåŠŸå–æ¶ˆ');
                    refreshPipelines();
                    refreshQueueStats();
                } else {
                    const error = await response.json();
                    showNotification('error', 'å–æ¶ˆå¤±è´¥', error.error || 'æœªçŸ¥é”™è¯¯');
                }
            } catch (error) {
                showNotification('error', 'å–æ¶ˆå¤±è´¥', error.message || 'ç½‘ç»œé”™è¯¯');
            }
        }

        // å¤åˆ¶ Pipeline YAML
        async function copyPipelineYAML(id, btnElement) {
            try {
                const response = await fetch(`${API_BASE}/pipelines/${id}`);
                const pipeline = await response.json();
                
                if (!pipeline.yaml) {
                    showNotification('warning', 'å¤åˆ¶å¤±è´¥', 'Pipeline å®šä¹‰ä¸ºç©º');
                    return;
                }

                // ä½¿ç”¨ Clipboard API å¤åˆ¶
                await navigator.clipboard.writeText(pipeline.yaml);
                
                // æ›´æ–°æŒ‰é’®çŠ¶æ€
                if (btnElement) {
                    const originalText = btnElement.textContent;
                    btnElement.textContent = 'âœ… å·²å¤åˆ¶';
                    btnElement.classList.add('copied');
                    setTimeout(() => {
                        btnElement.textContent = originalText;
                        btnElement.classList.remove('copied');
                    }, 2000);
                }
                
                showNotification('success', 'å¤åˆ¶æˆåŠŸ', 'Pipeline å®šä¹‰å·²å¤åˆ¶åˆ°å‰ªè´´æ¿');
            } catch (error) {
                showNotification('error', 'å¤åˆ¶å¤±è´¥', error.message || 'ç½‘ç»œé”™è¯¯');
            }
        }

        // ç‚¹å‡» overlay å…³é—­æ‰€æœ‰ drawer
        document.getElementById('drawer-overlay').addEventListener('click', () => {
            closeAllDrawers();
        });
    </script>
</body>
</html>
