<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pipeline Console</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: #f5f5f5;
            color: #333;
            line-height: 1.6;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px 0;
            margin-bottom: 30px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        header h1 {
            text-align: center;
            font-size: 28px;
            font-weight: 600;
        }

        .toolbar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            background: white;
            padding: 15px 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .toolbar button {
            background: #667eea;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            transition: background 0.3s;
        }

        .toolbar button:hover {
            background: #5568d3;
        }

        .toolbar button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }

        .status-filter {
            display: flex;
            gap: 10px;
        }

        .status-filter button {
            background: #f0f0f0;
            color: #333;
            padding: 8px 16px;
        }

        .status-filter button.active {
            background: #667eea;
            color: white;
        }

        .pipelines-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .pipeline-card {
            background: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            transition: transform 0.2s, box-shadow 0.2s;
            cursor: pointer;
        }

        .pipeline-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }

        .pipeline-card.running {
            border-left: 4px solid #667eea;
        }

        .pipeline-card.succeeded {
            border-left: 4px solid #10b981;
        }

        .pipeline-card.failed {
            border-left: 4px solid #ef4444;
        }

        .pipeline-card.pending {
            border-left: 4px solid #f59e0b;
        }

        .pipeline-header {
            display: flex;
            justify-content: space-between;
            align-items: start;
            margin-bottom: 15px;
        }

        .pipeline-name {
            font-size: 18px;
            font-weight: 600;
            color: #1f2937;
            margin-bottom: 5px;
        }

        .pipeline-id {
            font-size: 12px;
            color: #6b7280;
            font-family: monospace;
        }

        .pipeline-status {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
        }

        .pipeline-status.running {
            background: #dbeafe;
            color: #1e40af;
        }

        .pipeline-status.succeeded {
            background: #d1fae5;
            color: #065f46;
        }

        .pipeline-status.failed {
            background: #fee2e2;
            color: #991b1b;
        }

        .pipeline-status.pending {
            background: #fef3c7;
            color: #92400e;
        }

        .pipeline-info {
            display: flex;
            flex-direction: column;
            gap: 8px;
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid #e5e7eb;
        }

        .pipeline-info-item {
            display: flex;
            justify-content: space-between;
            font-size: 14px;
        }

        .pipeline-info-label {
            color: #6b7280;
        }

        .pipeline-info-value {
            color: #1f2937;
            font-weight: 500;
        }


        .logs-container {
            background: #1f2937;
            color: #e5e7eb;
            padding: 15px;
            border-radius: 6px;
            font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
            font-size: 13px;
            line-height: 1.6;
            max-height: 500px;
            overflow-y: auto;
        }

        .log-entry {
            margin-bottom: 4px;
            word-wrap: break-word;
        }

        .log-entry.stdout {
            color: #e5e7eb;
        }

        .log-entry.stderr {
            color: #fca5a5;
        }

        .log-entry.status {
            color: #93c5fd;
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #6b7280;
        }

        .empty-state svg {
            width: 120px;
            height: 120px;
            margin-bottom: 20px;
            opacity: 0.5;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #6b7280;
        }

        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .pipeline-details {
            margin-bottom: 20px;
        }

        .detail-row {
            display: flex;
            padding: 12px 0;
            border-bottom: 1px solid #e5e7eb;
        }

        .detail-label {
            width: 150px;
            color: #6b7280;
            font-weight: 500;
        }

        .detail-value {
            flex: 1;
            color: #1f2937;
        }

        .tabs {
            display: flex;
            border-bottom: 2px solid #e5e7eb;
            margin: 20px 0;
        }

        .tab {
            padding: 12px 20px;
            cursor: pointer;
            color: #6b7280;
            font-weight: 500;
            border-bottom: 2px solid transparent;
            margin-bottom: -2px;
            transition: color 0.3s;
        }

        .tab:hover {
            color: #1f2937;
        }

        .tab.active {
            color: #667eea;
            border-bottom-color: #667eea;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .yaml-viewer {
            background: #1f2937;
            color: #e5e7eb;
            padding: 15px;
            border-radius: 6px;
            font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
            font-size: 13px;
            line-height: 1.6;
            max-height: 500px;
            overflow-y: auto;
            white-space: pre-wrap;
            word-wrap: break-word;
        }

        .settings-form {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .form-label {
            font-weight: 500;
            color: #1f2937;
        }

        .form-input {
            padding: 10px;
            border: 1px solid #e5e7eb;
            border-radius: 6px;
            font-size: 14px;
        }

        .form-input:focus {
            outline: none;
            border-color: #667eea;
        }

        .form-help {
            font-size: 12px;
            color: #6b7280;
        }

        .error-message {
            background: #fee2e2;
            color: #991b1b;
            padding: 12px;
            border-radius: 6px;
            margin-top: 15px;
        }

        .yaml-editor {
            width: 100%;
            min-height: 400px;
            font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
            font-size: 14px;
            padding: 12px;
            border: 1px solid #e5e7eb;
            border-radius: 6px;
            resize: vertical;
        }

        .execute-actions {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }

        .execute-actions button {
            background: #667eea;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            transition: background 0.3s;
            flex: 1;
        }

        .execute-actions button:hover {
            background: #5568d3;
        }

        .execute-actions button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }

        .execute-actions button.secondary {
            background: #f0f0f0;
            color: #333;
        }

        .execute-actions button.secondary:hover {
            background: #e0e0e0;
        }

        .execution-logs {
            background: #1f2937;
            color: #e5e7eb;
            padding: 15px;
            border-radius: 6px;
            font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
            font-size: 13px;
            line-height: 1.6;
            max-height: 300px;
            overflow-y: auto;
            margin-top: 15px;
            display: none;
        }

        .execution-logs.active {
            display: block;
        }

        .execution-status {
            padding: 10px;
            border-radius: 6px;
            margin-top: 15px;
            font-weight: 500;
        }

        .execution-status.running {
            background: #dbeafe;
            color: #1e40af;
        }

        .execution-status.succeeded {
            background: #d1fae5;
            color: #065f46;
        }

        .execution-status.failed {
            background: #fee2e2;
            color: #991b1b;
        }

        /* Drawer æ ·å¼ */
        .drawer {
            position: fixed;
            top: 0;
            right: 0;
            width: 0;
            height: 100%;
            background: white;
            box-shadow: -2px 0 10px rgba(0,0,0,0.1);
            z-index: 1000;
            transition: width 0.3s ease;
            overflow: hidden;
        }

        .drawer.active {
            width: 50%;
            min-width: 600px;
            max-width: 1200px;
        }

        .drawer-content {
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .drawer-header {
            padding: 20px;
            border-bottom: 1px solid #e5e7eb;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-shrink: 0;
        }

        .drawer-header h2 {
            font-size: 20px;
            color: #1f2937;
            margin: 0;
        }

        .drawer-close {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #6b7280;
            padding: 0;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .drawer-close:hover {
            color: #1f2937;
        }

        .drawer-body {
            padding: 20px;
            overflow-y: auto;
            flex: 1;
        }

        .drawer-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 999;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease, visibility 0.3s ease;
        }

        .drawer-overlay.active {
            opacity: 1;
            visibility: visible;
        }

        @media (max-width: 768px) {
            .drawer.active {
                width: 100%;
                min-width: 100%;
            }
        }

        .queue-stats {
            background: white;
            padding: 15px 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 15px;
        }

        .queue-stats-title {
            font-size: 16px;
            font-weight: 600;
            color: #1f2937;
        }

        .queue-stats-items {
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
        }

        .queue-stat-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            min-width: 80px;
        }

        .queue-stat-label {
            font-size: 12px;
            color: #6b7280;
            margin-bottom: 4px;
        }

        .queue-stat-value {
            font-size: 20px;
            font-weight: 600;
            color: #1f2937;
        }

        .queue-stat-value.pending {
            color: #f59e0b;
        }

        .queue-stat-value.running {
            color: #667eea;
        }

        .queue-stat-value.succeeded {
            color: #10b981;
        }

        .queue-stat-value.failed {
            color: #ef4444;
        }

        /* Notification æ ·å¼ */
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background: white;
            padding: 16px 20px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            z-index: 2000;
            display: flex;
            align-items: center;
            gap: 12px;
            min-width: 300px;
            max-width: 500px;
            animation: slideInRight 0.3s ease;
            border-left: 4px solid #10b981;
        }

        .notification.success {
            border-left-color: #10b981;
        }

        .notification.error {
            border-left-color: #ef4444;
        }

        .notification.warning {
            border-left-color: #f59e0b;
        }

        .notification.info {
            border-left-color: #667eea;
        }

        .notification-icon {
            font-size: 24px;
            flex-shrink: 0;
        }

        .notification-content {
            flex: 1;
        }

        .notification-title {
            font-weight: 600;
            color: #1f2937;
            margin-bottom: 4px;
        }

        .notification-message {
            font-size: 14px;
            color: #6b7280;
        }

        .notification-close {
            background: none;
            border: none;
            font-size: 20px;
            cursor: pointer;
            color: #9ca3af;
            padding: 0;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }

        .notification-close:hover {
            color: #1f2937;
        }

        @keyframes slideInRight {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        @keyframes slideOutRight {
            from {
                transform: translateX(0);
                opacity: 1;
            }
            to {
                transform: translateX(100%);
                opacity: 0;
            }
        }

        .notification.hiding {
            animation: slideOutRight 0.3s ease;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>ğŸš€ Pipeline Console</h1>
        </header>

        <div class="toolbar">
            <div>
                <button onclick="showRunPipeline()" style="background: #10b981;">â• æ–°å»º Pipeline</button>
                <button onclick="refreshPipelines()">ğŸ”„ åˆ·æ–°</button>
                <button onclick="clearFilter()">æ¸…é™¤ç­›é€‰</button>
                <button onclick="showSettings()" style="background: #6b7280;">âš™ï¸ è®¾ç½®</button>
            </div>
            <div class="status-filter">
                <button onclick="filterByStatus('all')" class="active" id="filter-all">å…¨éƒ¨</button>
                <button onclick="filterByStatus('pending')" id="filter-pending">ç­‰å¾…ä¸­</button>
                <button onclick="filterByStatus('running')" id="filter-running">è¿è¡Œä¸­</button>
                <button onclick="filterByStatus('succeeded')" id="filter-succeeded">æˆåŠŸ</button>
                <button onclick="filterByStatus('failed')" id="filter-failed">å¤±è´¥</button>
            </div>
        </div>

        <!-- é˜Ÿåˆ—ç»Ÿè®¡ -->
        <div class="queue-stats" id="queue-stats">
            <div class="queue-stats-title">ğŸ“Š é˜Ÿåˆ—çŠ¶æ€</div>
            <div class="queue-stats-items">
                <div class="queue-stat-item">
                    <div class="queue-stat-label">æ€»ä»»åŠ¡</div>
                    <div class="queue-stat-value" id="stat-total">-</div>
                </div>
                <div class="queue-stat-item">
                    <div class="queue-stat-label">ç­‰å¾…ä¸­</div>
                    <div class="queue-stat-value pending" id="stat-pending">-</div>
                </div>
                <div class="queue-stat-item">
                    <div class="queue-stat-label">è¿è¡Œä¸­</div>
                    <div class="queue-stat-value running" id="stat-running">-</div>
                </div>
                <div class="queue-stat-item">
                    <div class="queue-stat-label">æˆåŠŸ</div>
                    <div class="queue-stat-value succeeded" id="stat-succeeded">-</div>
                </div>
                <div class="queue-stat-item">
                    <div class="queue-stat-label">å¤±è´¥</div>
                    <div class="queue-stat-value failed" id="stat-failed">-</div>
                </div>
                <div class="queue-stat-item">
                    <div class="queue-stat-label">å¹¶å‘æ•°</div>
                    <div class="queue-stat-value" id="stat-concurrent">- / -</div>
                </div>
            </div>
        </div>

        <div id="pipelines-container">
            <div class="loading">
                <div class="spinner"></div>
                <div>åŠ è½½ä¸­...</div>
            </div>
        </div>
    </div>

    <!-- Notification å®¹å™¨ -->
    <div id="notification-container"></div>

    <!-- Pipeline è¯¦æƒ… Drawer -->
    <div id="pipeline-drawer" class="drawer">
        <div class="drawer-content">
            <div class="drawer-header">
                <h2 id="drawer-title">Pipeline è¯¦æƒ…</h2>
                <button class="drawer-close" onclick="closePipelineDrawer()">&times;</button>
            </div>
            <div class="drawer-body">
                <div id="drawer-content">
                    <div class="loading">
                        <div class="spinner"></div>
                        <div>åŠ è½½ä¸­...</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Drawer Overlay -->
    <div id="drawer-overlay" class="drawer-overlay" onclick="closeAllDrawers()"></div>
    
    <!-- è®¾ç½® Drawer -->
    <div id="settings-drawer" class="drawer">
        <div class="drawer-content">
            <div class="drawer-header">
                <h2>ç³»ç»Ÿè®¾ç½®</h2>
                <button class="drawer-close" onclick="closeSettingsDrawer()">&times;</button>
            </div>
            <div class="drawer-body">
                <div class="settings-form">
                    <div class="form-group">
                        <label class="form-label">é˜Ÿåˆ—æœ€å¤§å¹¶å‘æ•°</label>
                        <input type="number" id="setting-max-concurrent" class="form-input" min="1" value="2">
                        <div class="form-help">åŒæ—¶æ‰§è¡Œçš„æœ€å¤§ pipeline æ•°é‡ï¼ˆé»˜è®¤: 2ï¼Œéœ€è¦é‡å¯æœåŠ¡ç”Ÿæ•ˆï¼‰</div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">å†å²è®°å½•ä¿ç•™æ•°é‡</label>
                        <input type="number" id="setting-max-records" class="form-input" min="1" value="1000">
                        <div class="form-help">æœ€å¤šä¿ç•™çš„å†å² pipeline è®°å½•æ•°é‡ï¼ˆé»˜è®¤: 1000ï¼‰</div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">è‡ªåŠ¨åˆ·æ–°é—´éš”ï¼ˆç§’ï¼‰</label>
                        <input type="number" id="setting-refresh-interval" class="form-input" min="1" value="5">
                        <div class="form-help">Web Console è‡ªåŠ¨åˆ·æ–°é—´éš”ï¼ˆé»˜è®¤: 5ç§’ï¼‰</div>
                    </div>
                    <div class="execute-actions">
                        <button onclick="saveSettings()">ğŸ’¾ ä¿å­˜è®¾ç½®</button>
                        <button onclick="closeSettingsDrawer()" class="secondary">å–æ¶ˆ</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- åˆ›å»º Pipeline Drawer -->
    <div id="run-pipeline-drawer" class="drawer">
        <div class="drawer-content">
            <div class="drawer-header">
                <h2>åˆ›å»º Pipeline</h2>
                <button class="drawer-close" onclick="closeRunDrawer()">&times;</button>
            </div>
            <div class="drawer-body">
                <div>
                    <label style="display: block; margin-bottom: 8px; font-weight: 500;">Pipeline é…ç½® (YAML):</label>
                    <textarea id="pipeline-yaml" class="yaml-editor" placeholder="è¯·è¾“å…¥ pipeline YAML é…ç½®...">name: My Pipeline

stages:
  - name: build
    jobs:
      - name: build-job
        steps:
          - name: hello
            command: echo "Hello, Pipeline!"</textarea>
                    <div class="execute-actions">
                        <button onclick="createPipeline()" id="create-btn">â• åˆ›å»º</button>
                        <button onclick="closeRunDrawer()" class="secondary">å–æ¶ˆ</button>
                    </div>
                    <div id="creation-status" class="execution-status" style="display: none;"></div>
                    <div id="creation-message" style="margin-top: 15px; padding: 12px; background: #f0f9ff; border-radius: 6px; color: #1e40af; font-size: 14px;">
                        ğŸ’¡ Pipeline å°†è¢«æ·»åŠ åˆ°æ‰§è¡Œé˜Ÿåˆ—ï¼Œé˜Ÿåˆ—ä¼šåœ¨åå°è‡ªåŠ¨æ£€æµ‹å¹¶æ‰§è¡Œã€‚æ‚¨å¯ä»¥åœ¨ Pipeline åˆ—è¡¨ä¸­æŸ¥çœ‹æ‰§è¡ŒçŠ¶æ€ã€‚
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const API_BASE = '/api/v1';
        let allPipelines = [];
        let currentFilter = 'all';

        // é¡µé¢åŠ è½½æ—¶è·å– pipeline åˆ—è¡¨å’Œé˜Ÿåˆ—çŠ¶æ€
        document.addEventListener('DOMContentLoaded', () => {
            refreshPipelines();
            refreshQueueStats();
            // æ¯5ç§’è‡ªåŠ¨åˆ·æ–°
            window.refreshInterval = setInterval(() => {
                refreshPipelines();
                refreshQueueStats();
            }, 5000);
        });

        // è·å– pipeline åˆ—è¡¨
        async function refreshPipelines() {
            try {
                const response = await fetch(`${API_BASE}/pipelines?limit=100`);
                const data = await response.json();
                allPipelines = data.data || [];
                renderPipelines();
            } catch (error) {
                console.error('Failed to fetch pipelines:', error);
                document.getElementById('pipelines-container').innerHTML = `
                    <div class="empty-state">
                        <div>âŒ åŠ è½½å¤±è´¥: ${error.message}</div>
                    </div>
                `;
            }
        }

        // è·å–é˜Ÿåˆ—ç»Ÿè®¡ä¿¡æ¯
        async function refreshQueueStats() {
            try {
                const response = await fetch(`${API_BASE}/queue/stats`);
                const stats = await response.json();
                
                document.getElementById('stat-total').textContent = stats.total || 0;
                document.getElementById('stat-pending').textContent = stats.pending || 0;
                document.getElementById('stat-running').textContent = stats.running || 0;
                document.getElementById('stat-succeeded').textContent = stats.succeeded || 0;
                document.getElementById('stat-failed').textContent = stats.failed || 0;
                document.getElementById('stat-concurrent').textContent = 
                    `${stats.current_concurrent || 0} / ${stats.max_concurrent || 0}`;
            } catch (error) {
                console.error('Failed to fetch queue stats:', error);
            }
        }

        // æ¸²æŸ“ pipeline åˆ—è¡¨
        function renderPipelines() {
            const container = document.getElementById('pipelines-container');
            const filtered = filterPipelines();

            if (filtered.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
                        </svg>
                        <h3>æš‚æ—  Pipeline</h3>
                        <p>å½“å‰æ²¡æœ‰æ‰¾åˆ°ç¬¦åˆæ¡ä»¶çš„ pipeline è®°å½•</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = `
                <div class="pipelines-grid">
                    ${filtered.map(p => createPipelineCard(p)).join('')}
                </div>
            `;
        }

        // åˆ›å»º pipeline å¡ç‰‡
        function createPipelineCard(pipeline) {
            const duration = getDuration(pipeline);
            const startedAt = formatTime(pipeline.started_at);
            
            return `
                <div class="pipeline-card ${pipeline.status}" onclick="showPipelineDetails('${pipeline.id}')">
                    <div class="pipeline-header">
                        <div>
                            <div class="pipeline-name">${escapeHtml(pipeline.name || 'Unnamed')}</div>
                            <div class="pipeline-id">${pipeline.id}</div>
                        </div>
                        <span class="pipeline-status ${pipeline.status}">${pipeline.status}</span>
                    </div>
                    <div class="pipeline-info">
                        <div class="pipeline-info-item">
                            <span class="pipeline-info-label">å¼€å§‹æ—¶é—´:</span>
                            <span class="pipeline-info-value">${startedAt}</span>
                        </div>
                        <div class="pipeline-info-item">
                            <span class="pipeline-info-label">è¿è¡Œæ—¶é•¿:</span>
                            <span class="pipeline-info-value">${duration}</span>
                        </div>
                        ${pipeline.succeed_at ? `
                            <div class="pipeline-info-item">
                                <span class="pipeline-info-label">å®Œæˆæ—¶é—´:</span>
                                <span class="pipeline-info-value">${formatTime(pipeline.succeed_at)}</span>
                            </div>
                        ` : ''}
                        ${pipeline.failed_at ? `
                            <div class="pipeline-info-item">
                                <span class="pipeline-info-label">å¤±è´¥æ—¶é—´:</span>
                                <span class="pipeline-info-value">${formatTime(pipeline.failed_at)}</span>
                            </div>
                        ` : ''}
                    </div>
                </div>
            `;
        }

        // ç­›é€‰ pipeline
        function filterPipelines() {
            if (currentFilter === 'all') {
                return allPipelines;
            }
            return allPipelines.filter(p => p.status === currentFilter);
        }

        // æŒ‰çŠ¶æ€ç­›é€‰
        function filterByStatus(status) {
            currentFilter = status;
            
            // æ›´æ–°æŒ‰é’®çŠ¶æ€
            document.querySelectorAll('.status-filter button').forEach(btn => {
                btn.classList.remove('active');
            });
            document.getElementById(`filter-${status}`).classList.add('active');
            
            renderPipelines();
        }

        // æ¸…é™¤ç­›é€‰
        function clearFilter() {
            filterByStatus('all');
        }

        // æ˜¾ç¤º pipeline è¯¦æƒ…
        async function showPipelineDetails(id) {
            const drawer = document.getElementById('pipeline-drawer');
            const content = document.getElementById('drawer-content');
            
            document.getElementById('drawer-overlay').classList.add('active');
            drawer.classList.add('active');
            content.innerHTML = `
                <div class="loading">
                    <div class="spinner"></div>
                    <div>åŠ è½½ä¸­...</div>
                </div>
            `;

            try {
                const response = await fetch(`${API_BASE}/pipelines/${id}`);
                const pipeline = await response.json();

                document.getElementById('drawer-title').textContent = `${pipeline.name || 'Unnamed'} - ${pipeline.id}`;
                
                content.innerHTML = `
                    <div class="pipeline-details">
                        <div class="detail-row">
                            <div class="detail-label">çŠ¶æ€:</div>
                            <div class="detail-value">
                                <span class="pipeline-status ${pipeline.status}">${pipeline.status}</span>
                            </div>
                        </div>
                        <div class="detail-row">
                            <div class="detail-label">å¼€å§‹æ—¶é—´:</div>
                            <div class="detail-value">${formatTime(pipeline.started_at)}</div>
                        </div>
                        ${pipeline.succeed_at ? `
                            <div class="detail-row">
                                <div class="detail-label">å®Œæˆæ—¶é—´:</div>
                                <div class="detail-value">${formatTime(pipeline.succeed_at)}</div>
                            </div>
                        ` : ''}
                        ${pipeline.failed_at ? `
                            <div class="detail-row">
                                <div class="detail-label">å¤±è´¥æ—¶é—´:</div>
                                <div class="detail-value">${formatTime(pipeline.failed_at)}</div>
                            </div>
                        ` : ''}
                        <div class="detail-row">
                            <div class="detail-label">è¿è¡Œæ—¶é•¿:</div>
                            <div class="detail-value">${getDuration(pipeline)}</div>
                        </div>
                        ${pipeline.error ? `
                            <div class="error-message">
                                <strong>é”™è¯¯ä¿¡æ¯:</strong><br>
                                ${escapeHtml(pipeline.error)}
                            </div>
                        ` : ''}
                    </div>
                    <div class="tabs">
                        <div class="tab active" onclick="switchTab('logs')">æ—¥å¿—</div>
                        <div class="tab" onclick="switchTab('yaml')">Pipeline å®šä¹‰</div>
                    </div>
                    <div id="tab-logs" class="tab-content active">
                        <div class="logs-container" id="logs-container">
                            ${pipeline.logs && pipeline.logs.length > 0 
                                ? pipeline.logs.map(log => `
                                    <div class="log-entry ${log.type}">
                                        [${formatTime(log.timestamp)}] ${escapeHtml(log.message)}
                                    </div>
                                `).join('')
                                : '<div style="color: #6b7280;">æš‚æ— æ—¥å¿—</div>'
                            }
                        </div>
                    </div>
                    <div id="tab-yaml" class="tab-content">
                        <div class="yaml-viewer">${pipeline.yaml ? escapeHtml(pipeline.yaml) : '<div style="color: #6b7280;">æš‚æ—  Pipeline å®šä¹‰</div>'}</div>
                    </div>
                `;

                // æ»šåŠ¨åˆ°åº•éƒ¨
                const logsContainer = document.getElementById('logs-container');
                if (logsContainer) {
                    logsContainer.scrollTop = logsContainer.scrollHeight;
                }
            } catch (error) {
                content.innerHTML = `
                    <div class="empty-state">
                        <div>âŒ åŠ è½½å¤±è´¥: ${error.message}</div>
                    </div>
                `;
            }
        }

        // å…³é—­ Pipeline è¯¦æƒ… Drawer
        function closePipelineDrawer() {
            document.getElementById('drawer-overlay').classList.remove('active');
            document.getElementById('pipeline-drawer').classList.remove('active');
        }

        // å…³é—­æ‰€æœ‰ Drawer
        function closeAllDrawers() {
            document.getElementById('drawer-overlay').classList.remove('active');
            document.getElementById('pipeline-drawer').classList.remove('active');
            document.getElementById('run-pipeline-drawer').classList.remove('active');
            document.getElementById('settings-drawer').classList.remove('active');
        }

        // æ ‡ç­¾é¡µåˆ‡æ¢
        function switchTab(tabName) {
            // éšè—æ‰€æœ‰æ ‡ç­¾é¡µå†…å®¹
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            // ç§»é™¤æ‰€æœ‰æ ‡ç­¾çš„ active çŠ¶æ€
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });
            // æ˜¾ç¤ºé€‰ä¸­çš„æ ‡ç­¾é¡µ
            const tabContent = document.getElementById(`tab-${tabName}`);
            if (tabContent) {
                tabContent.classList.add('active');
            }
            // æ¿€æ´»å¯¹åº”çš„æ ‡ç­¾
            const tabs = document.querySelectorAll('.tab');
            tabs.forEach((tab, index) => {
                if ((tabName === 'logs' && index === 0) || (tabName === 'yaml' && index === 1)) {
                    tab.classList.add('active');
                }
            });
        }

        // æ˜¾ç¤ºè®¾ç½®é¢æ¿
        function showSettings() {
            closeAllDrawers();
            document.getElementById('drawer-overlay').classList.add('active');
            document.getElementById('settings-drawer').classList.add('active');
            
            // åŠ è½½å½“å‰è®¾ç½®
            loadSettings();
        }

        // å…³é—­è®¾ç½®é¢æ¿
        function closeSettingsDrawer() {
            closeAllDrawers();
        }

        // åŠ è½½è®¾ç½®
        async function loadSettings() {
            try {
                const response = await fetch(`${API_BASE}/settings`);
                const settings = await response.json();
                
                document.getElementById('setting-max-concurrent').value = settings.max_concurrent || 2;
                document.getElementById('setting-max-records').value = settings.max_records || 1000;
                document.getElementById('setting-refresh-interval').value = settings.refresh_interval || 5;
            } catch (error) {
                console.error('Failed to load settings:', error);
            }
        }

        // ä¿å­˜è®¾ç½®
        async function saveSettings() {
            const settings = {
                max_concurrent: parseInt(document.getElementById('setting-max-concurrent').value) || 2,
                max_records: parseInt(document.getElementById('setting-max-records').value) || 1000,
                refresh_interval: parseInt(document.getElementById('setting-refresh-interval').value) || 5,
            };

            try {
                const response = await fetch(`${API_BASE}/settings`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(settings),
                });

                if (response.ok) {
                    alert('è®¾ç½®å·²ä¿å­˜');
                    closeSettingsDrawer();
                    // æ›´æ–°åˆ·æ–°é—´éš”
                    if (window.refreshInterval) {
                        clearInterval(window.refreshInterval);
                    }
                    window.refreshInterval = setInterval(() => {
                        refreshPipelines();
                        refreshQueueStats();
                    }, settings.refresh_interval * 1000);
                } else {
                    alert('ä¿å­˜è®¾ç½®å¤±è´¥');
                }
            } catch (error) {
                console.error('Failed to save settings:', error);
                alert('ä¿å­˜è®¾ç½®å¤±è´¥: ' + error.message);
            }
        }

        // å·¥å…·å‡½æ•°
        function formatTime(timeStr) {
            if (!timeStr) return 'N/A';
            const date = new Date(timeStr);
            return date.toLocaleString('zh-CN');
        }

        function getDuration(pipeline) {
            const start = new Date(pipeline.started_at);
            const end = pipeline.succeed_at 
                ? new Date(pipeline.succeed_at)
                : pipeline.failed_at
                ? new Date(pipeline.failed_at)
                : new Date();
            
            const diff = Math.floor((end - start) / 1000);
            if (diff < 60) {
                return diff + 'ç§’';
            }
            if (diff < 3600) {
                const minutes = Math.floor(diff / 60);
                const seconds = diff % 60;
                return minutes + 'åˆ†' + seconds + 'ç§’';
            }
            const hours = Math.floor(diff / 3600);
            const minutes = Math.floor((diff % 3600) / 60);
            return hours + 'å°æ—¶' + minutes + 'åˆ†';
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // æ˜¾ç¤ºåˆ›å»º Pipeline Drawer
        function showRunPipeline() {
            // å…ˆå…³é—­å…¶ä»– drawer
            closePipelineDrawer();
            document.getElementById('drawer-overlay').classList.add('active');
            document.getElementById('run-pipeline-drawer').classList.add('active');
            document.getElementById('pipeline-yaml').value = `name: My Pipeline

stages:
  - name: build
    jobs:
      - name: build-job
        steps:
          - name: hello
            command: echo "Hello, Pipeline!"`;
            document.getElementById('creation-status').style.display = 'none';
            document.getElementById('create-btn').disabled = false;
        }

        // å…³é—­åˆ›å»º Drawer
        function closeRunDrawer() {
            closeAllDrawers();
        }

        // åˆ›å»º Pipelineï¼ˆåŠ å…¥é˜Ÿåˆ—ï¼‰
        async function createPipeline() {
            const yaml = document.getElementById('pipeline-yaml').value.trim();
            if (!yaml) {
                alert('è¯·è¾“å…¥ Pipeline é…ç½®');
                return;
            }

            const createBtn = document.getElementById('create-btn');
            const statusDiv = document.getElementById('creation-status');

            createBtn.disabled = true;
            statusDiv.style.display = 'block';
            statusDiv.className = 'execution-status running';
            statusDiv.textContent = 'æ­£åœ¨åˆ›å»º Pipeline...';

            try {
                // è·å– WebSocket è·¯å¾„
                const wsProtocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
                const wsPath = window.location.pathname.replace('/console', '') || '/';
                const wsURL = `${wsProtocol}//${window.location.host}${wsPath}`;

                // åˆ›å»º WebSocket è¿æ¥
                const ws = new WebSocket(wsURL);

                ws.onopen = () => {
                    statusDiv.textContent = 'æ­£åœ¨æ·»åŠ åˆ°é˜Ÿåˆ—...';

                    // å‘é€ pipeline é…ç½®
                    const action = {
                        type: 'run',
                        payload: yaml
                    };
                    ws.send(JSON.stringify(action));
                };

                ws.onmessage = (event) => {
                    try {
                        const msg = JSON.parse(event.data);
                        if (msg.type === 'done') {
                            // æ˜¾ç¤ºæˆåŠŸé€šçŸ¥
                            showNotification('success', 'Pipeline åˆ›å»ºæˆåŠŸ', 'Pipeline å·²æˆåŠŸæ·»åŠ åˆ°æ‰§è¡Œé˜Ÿåˆ—');
                            // ç«‹å³å…³é—­ Drawer å¹¶åˆ·æ–°
                            refreshPipelines();
                            refreshQueueStats();
                            closeRunDrawer();
                        } else if (msg.type === 'error') {
                            showNotification('error', 'åˆ›å»ºå¤±è´¥', msg.payload || 'æœªçŸ¥é”™è¯¯');
                            statusDiv.className = 'execution-status failed';
                            statusDiv.textContent = `âŒ åˆ›å»ºå¤±è´¥: ${msg.payload || 'æœªçŸ¥é”™è¯¯'}`;
                            createBtn.disabled = false;
                        }
                    } catch (error) {
                        // å¿½ç•¥è§£æé”™è¯¯
                    }
                };

                ws.onerror = (error) => {
                    statusDiv.className = 'execution-status failed';
                    statusDiv.textContent = `âŒ è¿æ¥é”™è¯¯: ${error}`;
                    createBtn.disabled = false;
                };

                ws.onclose = () => {
                    if (statusDiv.textContent.includes('æ­£åœ¨')) {
                        statusDiv.className = 'execution-status failed';
                        statusDiv.textContent = 'âŒ è¿æ¥å·²å…³é—­';
                        createBtn.disabled = false;
                    }
                };

            } catch (error) {
                showNotification('error', 'åˆ›å»ºå¤±è´¥', error.message);
                statusDiv.className = 'execution-status failed';
                statusDiv.textContent = `âŒ åˆ›å»ºå¤±è´¥: ${error.message}`;
                createBtn.disabled = false;
            }
        }

        // æ˜¾ç¤ºé€šçŸ¥
        function showNotification(type, title, message) {
            const container = document.getElementById('notification-container');
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            
            const icons = {
                success: 'âœ…',
                error: 'âŒ',
                warning: 'âš ï¸',
                info: 'â„¹ï¸'
            };

            notification.innerHTML = `
                <div class="notification-icon">${icons[type] || 'â„¹ï¸'}</div>
                <div class="notification-content">
                    <div class="notification-title">${escapeHtml(title)}</div>
                    <div class="notification-message">${escapeHtml(message)}</div>
                </div>
                <button class="notification-close" onclick="closeNotification(this)">&times;</button>
            `;

            container.appendChild(notification);

            // 3ç§’åè‡ªåŠ¨å…³é—­
            setTimeout(() => {
                closeNotification(notification.querySelector('.notification-close'));
            }, 3000);
        }

        // å…³é—­é€šçŸ¥
        function closeNotification(btn) {
            const notification = btn.closest('.notification');
            if (notification) {
                notification.classList.add('hiding');
                setTimeout(() => {
                    notification.remove();
                }, 300);
            }
        }

        // ç‚¹å‡» overlay å…³é—­æ‰€æœ‰ drawer
        document.getElementById('drawer-overlay').addEventListener('click', () => {
            closeAllDrawers();
        });
    </script>
</body>
</html>
